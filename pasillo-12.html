<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Operativa Pro</title>
    
    <!-- 1. Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Cargar Babel para traducir JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos base -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 4. Tu Código de Aplicación -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const { useState, useEffect } = React;

        // --- ICONOS SVG (Para evitar dependencias externas complejas) ---
        const Icon = ({ path, className, size = 24, onClick }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                onClick={onClick}
                style={{ cursor: onClick ? 'pointer' : 'inherit' }}
            >
                {path}
            </svg>
        );

        const Icons = {
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            History: (p) => <Icon {...p} path={<><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>} />,
            Layout: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></>} />,
            CheckCircle2: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            Briefcase: (p) => <Icon {...p} path={<><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></>} />,
            Coffee: (p) => <Icon {...p} path={<><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></>} />,
            ShieldCheck: (p) => <Icon {...p} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />
        };

        // --- CONFIGURACIÓN DE FIREBASE ---
        const fallbackConfig = {
            apiKey: "TU_API_KEY_AQUI",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Variables globales inyectadas por el entorno de Canvas o Fallback
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' 
            ? JSON.parse(window.__firebase_config) 
            : fallbackConfig;
        
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'gestion-operativa-pro-v4';
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [semanas, setSemanas] = useState([]);
            const [view, setView] = useState('current');
            
            // Estados para el Modal
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [activeColKey, setActiveColKey] = useState(null);
            const [newItemText, setNewItemText] = useState('');

            // Estado para Edición Directa (Planificador)
            const [editingItem, setEditingItem] = useState({ col: null, index: null, text: '' });

            // Estado para Edición en Historial
            const [editingHistoryItem, setEditingHistoryItem] = useState({ docId: null, colKey: null, itemIndex: null, text: '' });

            const defaultItems = [
                { text: 'INF PERSONALES', status: 'open' },
                { text: 'GESTION / LIQUIDEZ', status: 'open' }
            ];

            const initialFormState = {
                fecha: new Date().toISOString().split('T')[0],
                equipoOperativo: 'EQUIPO 4 DE OPERATIVO',
                merienda: '04:15 PM',
                columnas: {
                    encuentro: { titulo: 'ENCUENTRO', subtitulo: 'KIWI', color: 'from-emerald-500 to-teal-600', items: [...defaultItems] },
                    estacionamiento: { titulo: 'ESTACIONAMIENTO', subtitulo: 'MANZANA', color: 'from-rose-500 to-red-600', items: [...defaultItems] },
                    feria: { titulo: 'FERIA GRANDE', subtitulo: 'UVA', color: 'from-purple-500 to-indigo-600', items: [...defaultItems] }
                }
            };

            const [formData, setFormData] = useState(initialFormState);

            // --- Persistencia Local (Borrador) ---
            useEffect(() => {
                const savedDraft = localStorage.getItem('borrador_reunion_v4');
                if (savedDraft) {
                    try { setFormData(JSON.parse(savedDraft)); } catch (e) {}
                }
            }, []);

            useEffect(() => {
                if (formData) localStorage.setItem('borrador_reunion_v4', JSON.stringify(formData));
            }, [formData]);

            // --- Auth y Datos ---
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) { console.error("Error Auth:", error); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'registros_v4');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setSemanas(data.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)));
                }, (err) => console.error(err));
                return () => unsubscribe();
            }, [user]);

            // --- Funciones Lógicas ---
            const openAddItemModal = (colKey) => {
                setActiveColKey(colKey);
                setNewItemText('');
                setIsModalOpen(true);
            };

            const handleConfirmAddItem = () => {
                if (!newItemText.trim()) return;
                setFormData(prev => ({
                    ...prev,
                    columnas: {
                        ...prev.columnas,
                        [activeColKey]: { 
                            ...prev.columnas[activeColKey], 
                            items: [...prev.columnas[activeColKey].items, { text: newItemText, status: 'open' }] 
                        }
                    }
                }));
                setIsModalOpen(false);
            };

            const toggleItemStatus = (itemsArray, index) => {
                const newItems = [...itemsArray];
                const item = newItems[index];
                let currentStatus = item.status || (item.completed ? 'completed' : 'open');
                let nextStatus = 'open';
                if (currentStatus === 'open') nextStatus = 'completed';
                else if (currentStatus === 'completed') nextStatus = 'pending';
                else if (currentStatus === 'pending') nextStatus = 'open';
                newItems[index] = { ...item, status: nextStatus, completed: nextStatus === 'completed' };
                return newItems;
            };

            const toggleItem = (colKey, index) => {
                const newItems = toggleItemStatus(formData.columnas[colKey].items, index);
                setFormData(prev => ({
                    ...prev,
                    columnas: {
                        ...prev.columnas,
                        [colKey]: { ...prev.columnas[colKey], items: newItems }
                    }
                }));
            };

            const handleRemoveItem = (colKey, index) => {
                setFormData(prev => ({
                    ...prev,
                    columnas: {
                        ...prev.columnas,
                        [colKey]: { ...prev.columnas[colKey], items: prev.columnas[colKey].items.filter((_, i) => i !== index) }
                    }
                }));
            };

             const startEditing = (colKey, index, text) => {
                setEditingItem({ col: colKey, index, text });
            };

            const saveEdit = () => {
                if (editingItem.col === null) return;
                const newItems = [...formData.columnas[editingItem.col].items];
                newItems[editingItem.index].text = editingItem.text;
                setFormData(prev => ({
                ...prev,
                columnas: {
                    ...prev.columnas,
                    [editingItem.col]: { ...prev.columnas[editingItem.col], items: newItems }
                }
                }));
                setEditingItem({ col: null, index: null, text: '' });
            };


            const saveSemana = async () => {
                if (!user || !db) return;
                try {
                    // 1. Guardar la semana actual en Historial
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registros_v4'), {
                        ...formData,
                        createdAt: new Date().getTime()
                    });

                    // 2. Preparar la nueva semana
                    // Creamos una copia fresca de la estructura inicial
                    const nextFormData = JSON.parse(JSON.stringify(initialFormState));
                    nextFormData.fecha = new Date().toISOString().split('T')[0]; // Fecha de hoy

                    // 3. Migrar los Pendientes (Amarillos)
                    Object.keys(formData.columnas).forEach(colKey => {
                        const currentItems = formData.columnas[colKey].items;
                        // Filtramos items amarillos (pending)
                        const pendingItems = currentItems.filter(item => item.status === 'pending');
                        
                        // Los transformamos a 'open' para que aparezcan como tareas activas en la nueva lista
                        const itemsToCarry = pendingItems.map(i => ({ 
                            text: i.text, 
                            status: 'open' 
                        }));
                        
                        // Los agregamos a los items por defecto de la nueva semana
                        nextFormData.columnas[colKey].items = [
                            ...nextFormData.columnas[colKey].items, 
                            ...itemsToCarry
                        ];
                    });

                    localStorage.setItem('borrador_reunion_v4', JSON.stringify(nextFormData));
                    setFormData(nextFormData);
                    setView('history');
                } catch (e) { console.error(e.message); }
            };

            // --- Historial ---
            const toggleHistoryItem = async (docId, colKey, itemIndex) => {
                if (!db) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'registros_v4', docId);
                const semana = semanas.find(s => s.id === docId);
                if (!semana) return;
                const newItems = toggleItemStatus(semana.columnas[colKey].items, itemIndex);
                try { await updateDoc(docRef, { [`columnas.${colKey}.items`]: newItems }); } catch (error) { console.error(error); }
            };

            const startEditingHistory = (docId, colKey, itemIndex, text) => {
                 setEditingHistoryItem({ docId, colKey, itemIndex, text });
            };

            const saveHistoryEdit = async () => {
                const { docId, colKey, itemIndex, text } = editingHistoryItem;
                if (!docId || !db) return;

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'registros_v4', docId);
                const semana = semanas.find(s => s.id === docId);
                
                if (semana) {
                const newItems = [...semana.columnas[colKey].items];
                newItems[itemIndex].text = text;
                try {
                    await updateDoc(docRef, { [`columnas.${colKey}.items`]: newItems });
                } catch (error) { console.error("Error guardando historial:", error); }
                }
                setEditingHistoryItem({ docId: null, colKey: null, itemIndex: null, text: '' });
            };


            const getItemStyles = (status) => {
                switch (status) {
                    case 'completed': return 'bg-emerald-50/50';
                    case 'pending': return 'bg-amber-50/50';
                    default: return 'hover:bg-slate-50';
                }
            };

             const getItemIcon = (status) => {
                switch (status) {
                    case 'completed': return <div className="bg-emerald-500 w-8 h-8 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200 transition-all scale-110"><Icons.CheckCircle2 size={18} className="text-white" /></div>;
                    case 'pending': return <div className="bg-amber-400 w-8 h-8 rounded-xl flex items-center justify-center shadow-lg shadow-amber-200 transition-all scale-110"><Icons.Clock size={18} className="text-white" /></div>;
                    default: return <div className="w-8 h-8 rounded-xl border-2 border-slate-200 flex items-center justify-center bg-white transition-all"></div>;
                }
            };

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="font-bold text-slate-400 animate-pulse uppercase tracking-widest">Cargando...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20 relative fade-in">
                    
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 animate-in zoom-in-95 duration-200">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h3 className="text-xl font-black text-slate-800">Nueva Información</h3>
                                        <p className="text-xs font-bold text-slate-400 uppercase">Sección: {formData.columnas[activeColKey]?.titulo}</p>
                                    </div>
                                    <button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400">
                                        <Icons.X size={20} />
                                    </button>
                                </div>
                                <textarea
                                    autoFocus
                                    placeholder="Escribe aquí..."
                                    className="w-full h-32 p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-blue-500 transition-all font-medium text-slate-700 mb-6 resize-none"
                                    value={newItemText}
                                    onChange={(e) => setNewItemText(e.target.value)}
                                />
                                <div className="flex gap-3">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-4 font-black text-slate-400 hover:bg-slate-50 rounded-2xl transition-all">CANCELAR</button>
                                    <button onClick={handleConfirmAddItem} className="flex-1 py-4 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-2xl shadow-lg shadow-blue-200 transition-all active:scale-95">AGREGAR</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
                        <div className="max-w-[96%] mx-auto px-4 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-200">
                                    <Icons.ShieldCheck className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black tracking-tight text-slate-800 uppercase">Puntos <span className="text-blue-600 italic">  </span></h1>
                                    <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Feria del Este</p>
                                </div>
                            </div>
                            <nav className="flex bg-slate-100 p-1.5 rounded-2xl">
                                <button 
                                    onClick={() => setView('current')}
                                    className={`flex items-center gap-2 px-6 py-2 rounded-xl text-xs font-black transition-all uppercase ${view === 'current' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <Icons.Layout size={14} /> Planificar
                                </button>
                                <button 
                                    onClick={() => setView('history')}
                                    className={`flex items-center gap-2 px-6 py-2 rounded-xl text-xs font-black transition-all uppercase ${view === 'history' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <Icons.History size={14} /> Historial
                                </button>
                            </nav>
                        </div>
                    </header>

                    <main className="max-w-[96%] mx-auto px-4 mt-8">
                        {view === 'current' ? (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-4 mb-3">
                                            <div className="bg-blue-50 p-3 rounded-2xl text-blue-600"><Icons.Calendar size={18} /></div>
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fecha</span>
                                        </div>
                                        <input type="date" value={formData.fecha} onChange={(e) => setFormData({...formData, fecha: e.target.value})} className="w-full bg-transparent text-xl font-black outline-none border-b-2 border-transparent focus:border-blue-100 pb-1 cursor-pointer" />
                                    </div>
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-4 mb-3">
                                            <div className="bg-amber-50 p-3 rounded-2xl text-amber-600"><Icons.Users size={18} /></div>
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">A Cargo</span>
                                        </div>
                                        <input type="text" value={formData.equipoOperativo} onChange={(e) => setFormData({...formData, equipoOperativo: e.target.value})} className="w-full bg-transparent text-xl font-black outline-none border-b-2 border-transparent focus:border-amber-100 pb-1" />
                                    </div>
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-4 mb-3">
                                            <div className="bg-purple-50 p-3 rounded-2xl text-purple-600"><Icons.Coffee size={18} /></div>
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Merienda</span>
                                        </div>
                                        <input type="text" value={formData.merienda} onChange={(e) => setFormData({...formData, merienda: e.target.value})} className="w-full bg-transparent text-xl font-black outline-none border-b-2 border-transparent focus:border-purple-100 pb-1" />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                                    {Object.entries(formData.columnas).map(([key, col]) => (
                                        <div key={key} className="bg-white rounded-[2rem] shadow-xl shadow-slate-200/40 border border-slate-100 flex flex-col overflow-hidden transition-all hover:translate-y-[-4px]">
                                            <div className={`bg-gradient-to-br ${col.color} p-8 text-white relative`}>
                                                <div className="relative z-10">
                                                    <input value={col.titulo} onChange={(e) => { const newCols = {...formData.columnas}; newCols[key].titulo = e.target.value; setFormData({...formData, columnas: newCols}); }} className="bg-transparent text-3xl font-black tracking-tighter w-full outline-none hover:bg-white/10 rounded px-1 transition-colors uppercase" />
                                                    <input value={col.subtitulo} onChange={(e) => { const newCols = {...formData.columnas}; newCols[key].subtitulo = e.target.value; setFormData({...formData, columnas: newCols}); }} className="mt-2 bg-white/20 px-3 py-1 rounded-full text-[10px] font-black backdrop-blur-md uppercase outline-none focus:bg-white/40 block w-max" />
                                                </div>
                                                <button onClick={() => openAddItemModal(key)} className="absolute bottom-[-1.5rem] right-8 bg-white text-slate-900 w-12 h-12 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 active:scale-90 transition-all z-20 group">
                                                    <Icons.Plus className="group-hover:rotate-90 transition-transform" />
                                                </button>
                                            </div>

                                            <div className="p-4 pt-12 flex-grow flex flex-col min-h-[500px]">
                                                {col.items.map((item, idx) => {
                                                    const itemStatus = item.status || (item.completed ? 'completed' : 'open');
                                                    return (
                                                        <div key={idx} className={`group py-6 px-6 border-b border-slate-100 last:border-0 flex items-center gap-5 transition-all duration-300 ${getItemStyles(itemStatus)}`}>
                                                            <button onClick={() => toggleItem(key, idx)} className="shrink-0 outline-none focus:scale-110 active:scale-90 transition-transform">
                                                                {getItemIcon(itemStatus)}
                                                            </button>
                                                            <div className="flex-grow">
                                                                {editingItem.col === key && editingItem.index === idx ? (
                                                                    <input autoFocus value={editingItem.text} onChange={(e) => setEditingItem({...editingItem, text: e.target.value})} onBlur={saveEdit} onKeyDown={(e) => e.key === 'Enter' && saveEdit()} className="w-full bg-white border border-blue-200 rounded px-2 py-1 font-bold text-base outline-none shadow-sm" />
                                                                ) : (
                                                                    <span onClick={() => startEditing(key, idx, item.text)} className={`font-bold text-sm md:text-base cursor-text block transition-colors ${itemStatus === 'completed' ? 'text-emerald-800 opacity-60' : itemStatus === 'pending' ? 'text-amber-800' : 'text-slate-700'}`}>
                                                                        {item.text}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                                                <button onClick={() => handleRemoveItem(key, idx)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg"><Icons.Trash2 size={16} /></button>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {col.items.length === 0 && (
                                                    <div className="flex flex-col items-center justify-center h-full opacity-20 py-10">
                                                        <Icons.AlertCircle size={48} className="text-slate-400 mb-2" />
                                                        <span className="text-[10px] font-black uppercase tracking-widest">Sin Pendientes</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex flex-col items-center pt-10 gap-4">
                                    <button onClick={saveSemana} className="bg-slate-900 hover:bg-blue-600 text-white px-16 py-6 rounded-[2rem] font-black text-lg flex items-center gap-4 shadow-2xl transition-all hover:-translate-y-2 active:scale-95 group">
                                        <Icons.Save size={24} /> FINALIZAR Y GUARDAR <Icons.ArrowRight size={20} className="group-hover:translate-x-2 transition-transform" />
                                    </button>
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Se guardará copia en el historial.</p>
                                </div>
                            </div>
                        ) : (
                            <div className="animate-in pb-20">
                                <div className="flex items-center justify-between mb-10">
                                    <div>
                                        <h2 className="text-3xl font-black text-slate-800 tracking-tighter uppercase italic">Archivo Digital</h2>
                                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Semanas Anteriores</p>
                                    </div>
                                    <div className="bg-blue-600 text-white px-6 py-2 rounded-2xl text-xs font-black shadow-lg shadow-blue-200">
                                        {semanas.length} REGISTROS
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 gap-8">
                                    {semanas.map((s) => (
                                        <div key={s.id} className="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm hover:shadow-2xl transition-all group overflow-hidden">
                                            <div className="p-8">
                                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b border-slate-100 pb-6">
                                                    <div className="flex items-center gap-4">
                                                        <div className="bg-slate-100 p-4 rounded-[1.5rem] group-hover:bg-blue-50 transition-colors">
                                                            <Icons.Calendar className="text-slate-400 group-hover:text-blue-500 transition-colors" size={24} />
                                                        </div>
                                                        <div>
                                                            <h3 className="text-3xl font-black tracking-tighter text-slate-800">{s.fecha}</h3>
                                                            <div className="flex gap-4 mt-1">
                                                                <div className="flex items-center gap-1 text-blue-600 font-black text-[10px] uppercase"><Icons.Briefcase size={12} /> {s.equipoOperativo}</div>
                                                                <div className="flex items-center gap-1 text-purple-600 font-black text-[10px] uppercase"><Icons.Coffee size={12} /> {s.merienda}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => { if(window.confirm("¿Eliminar?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registros_v4', s.id)); }} className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-3 rounded-xl transition-all">
                                                        <Icons.Trash2 size={20} />
                                                    </button>
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                    {Object.keys(s.columnas).map(k => {
                                                        const col = s.columnas[k];
                                                        return (
                                                            <div key={k} className="bg-slate-50/50 rounded-2xl p-6 space-y-4">
                                                                <div className="flex justify-between items-center mb-2">
                                                                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{col.titulo}</span>
                                                                    <span className="text-[10px] font-bold text-slate-300 uppercase">{col.subtitulo}</span>
                                                                </div>
                                                                <ul className="space-y-3">
                                                                    {col.items.map((item, idx) => {
                                                                        const itemStatus = item.status || (item.completed ? 'completed' : 'open');
                                                                        return (
                                                                            <li key={idx} className="flex items-center gap-3 text-sm group/item">
                                                                                <button onClick={() => toggleHistoryItem(s.id, k, idx)} className="shrink-0 outline-none hover:scale-110 active:scale-90 transition-transform">
                                                                                    {itemStatus === 'completed' && <div className="w-5 h-5 rounded bg-emerald-500 flex items-center justify-center"><Icons.CheckCircle2 size={12} className="text-white" /></div>}
                                                                                    {itemStatus === 'pending' && <div className="w-5 h-5 rounded bg-amber-400 flex items-center justify-center"><Icons.Clock size={12} className="text-white" /></div>}
                                                                                    {itemStatus === 'open' && <div className="w-5 h-5 rounded border-2 border-slate-300 bg-white"></div>}
                                                                                </button>
                                                                                <div className="flex-grow">
                                                                                     {editingHistoryItem.docId === s.id && editingHistoryItem.colKey === k && editingHistoryItem.itemIndex === idx ? (
                                                                                        <input 
                                                                                            autoFocus
                                                                                            value={editingHistoryItem.text}
                                                                                            onChange={(e) => setEditingHistoryItem({...editingHistoryItem, text: e.target.value})}
                                                                                            onBlur={saveHistoryEdit}
                                                                                            onKeyDown={(e) => e.key === 'Enter' && saveHistoryEdit()}
                                                                                            className="w-full bg-white border border-blue-300 rounded px-1 text-xs font-bold outline-none"
                                                                                        />
                                                                                        ) : (
                                                                                        <span 
                                                                                            onClick={() => startEditingHistory(s.id, k, idx, item.text)}
                                                                                            className={`text-xs font-bold uppercase leading-tight cursor-text hover:text-blue-600 transition-colors ${itemStatus === 'completed' ? 'text-emerald-700 opacity-60' : itemStatus === 'pending' ? 'text-amber-700' : 'text-slate-700'}`}
                                                                                        >
                                                                                            {item.text}
                                                                                        </span>
                                                                                        )}
                                                                                </div>
                                                                            </li>
                                                                        );
                                                                    })}
                                                                </ul>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
