<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVENTARIO DE VIVERES PASILLO 3 PANES</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importaciones de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales que ser√°n inicializadas al inicio
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.inventoryRef = null;

        // Configuraci√≥n y Inicializaci√≥n de Firebase
        const initFirebase = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig;
            try {
                firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            } catch (e) {
                console.error("Error al parsear __firebase_config:", e);
                return;
            }

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("La configuraci√≥n de Firebase est√° vac√≠a.");
                return;
            }

            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                
                // Autenticaci√≥n usando el token o an√≥nima
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Esperar a que el estado de autenticaci√≥n cambie y obtener el userId
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        console.log("Usuario autenticado:", window.currentUserId);
                        
                        // Definir la referencia del documento
                        const collectionPath = `/artifacts/${appId}/users/${window.currentUserId}/panes_inventory`;
                        window.inventoryRef = doc(window.db, collectionPath, 'current_data');

                        // Iniciar la escucha en tiempo real (onSnapshot)
                        if (window.startRealtimeListener) {
                            window.startRealtimeListener();
                        }
                    } else {
                        window.currentUserId = crypto.randomUUID();
                    }
                });

            } catch (e) {
                console.error("Error en la inicializaci√≥n de Firebase:", e);
            }
        };

        // Exportar initFirebase para usarlo en el script principal
        window.initFirebase = initFirebase;
    </script>
    <style>
        /* --- CONFIGURACI√ìN DE VARIABLES Y TEMA --- */
        :root {
            --neon-cyan: #22d3ee;
            --neon-lime: #a3e635;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #e5e7eb;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Utilidades */
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .neon-title { text-shadow: 0 0 5px rgba(34, 211, 238, 0.8); }
        
        /* --- ESTILOS DE TABLA (Simulaci√≥n Excel) --- */
        #inventory-table {
            border-collapse: separate; 
            border-spacing: 0;
            width: 100%;
            border: 1px solid #374151;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
        }
        
        .table-header, .table-data {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
        }

        .table-header {
            background-color: #1f2937;
            color: #22d3ee;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .table-row { transition: background-color 0.2s; }
        .table-row:last-child .table-data { border-bottom: none; }
        
        /* Modo Oscuro (Default) */
        .table-row:hover { background-color: #1f2937; }
        
        .product-cell {
            font-size: 0.95rem;
            color: #e5e7eb;
            border-right: 1px solid #374151;
        }

        .qty-cell {
            text-align: center;
            font-weight: bold;
            color: #a3e635;
            background-color: rgba(17, 24, 39, 0.5);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .qty-cell:hover {
            background-color: #374151;
            text-decoration: underline;
        }
        .zero-qty { color: #9ca3af !important; }

        /* --- TEMA CLARO --- */
        .light-theme body { background-color: #f3f4f6; color: #1f2937; }
        .light-theme .main-container { background-color: #ffffff; border-color: #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .light-theme .neon-title { color: #2563eb; text-shadow: none; }
        .light-theme .accent-text { color: #2563eb; }
        
        /* Tabla Claro */
        .light-theme #inventory-table { border-color: #e5e7eb; }
        .light-theme .table-header { background-color: #bfdbfe; color: #1e40af; border-bottom: 1px solid #93c5fd; }
        .light-theme .table-data { border-bottom: 1px solid #e5e7eb; }
        .light-theme .product-cell { color: #1f2937; border-right: 1px solid #e5e7eb; }
        .light-theme .table-row:hover { background-color: #f0f9ff; }
        .light-theme .qty-cell { background-color: #ecfdf5; color: #059669; }
        .light-theme .qty-cell:hover { background-color: #d1fae5; }
        .light-theme .zero-qty { color: #6b7280 !important; }

        /* Inputs y Footer Claro */
        .light-theme input[type="text"] { background-color: #ffffff; border-color: #94a3b8; color: #0f172a; }
        .light-theme .footer-container { background-color: #e2e8f0; border-color: #94a3b8; }
    </style>
</head>
<body class="p-2 md:p-6 min-h-screen">

    <div class="max-w-4xl mx-auto bg-gray-900 p-4 md:p-8 rounded-2xl shadow-2xl border border-cyan-900 main-container">
        <header class="mb-4">
            <!-- Cabecera tipo Reporte -->
            <div class="border border-gray-700 p-4 rounded-xl mb-6 bg-gray-800/50 light-theme:bg-white light-theme:border-blue-200 transition-colors">
                <!-- Fila 1: ORGANISMO Y FECHA -->
                <div class="flex flex-col md:flex-row justify-between md:items-center border-b border-gray-700 pb-2 mb-2 light-theme:border-gray-200">
                    <p class="text-xs font-bold text-cyan-400 light-theme:text-blue-600 tracking-wide mb-1 md:mb-0">CECOSESOLA J085030140</p>
                    <p class="text-xs text-gray-400 light-theme:text-gray-500">FECHA: <span id="report-date" class="font-semibold text-gray-200 light-theme:text-gray-800"></span></p>
                </div>
                
                <!-- Fila 2: PASILLO Y RESPONSABLES -->
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div class="mb-2 md:mb-0">
                        <h2 class="text-2xl md:text-3xl font-extrabold text-cyan-400 neon-title light-theme:text-blue-700 uppercase">üçû PASILLO PANES üçû</h2>
                        <h3 class="text-lg font-bold text-gray-300 light-theme:text-gray-600">FERIA DEL ESTE</h3>
                    </div>
                    
                    <div class="text-sm w-full md:w-auto bg-gray-900/50 p-2 rounded light-theme:bg-gray-100">
                        <p class="text-gray-400 light-theme:text-gray-500 mb-1">RESPONSABLE 1: <span id="resp1-display" class="font-semibold text-white light-theme:text-gray-800 uppercase">SIN NOMBRE</span></p>
                        <p class="text-gray-400 light-theme:text-gray-500">RESPONSABLE 2: <span id="resp2-display" class="font-semibold text-white light-theme:text-gray-800 uppercase">SIN NOMBRE</span></p>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex justify-end space-x-3 items-center sticky top-2 z-10 bg-gray-900/90 p-2 rounded-xl backdrop-blur-sm light-theme:bg-white/90">
                <div class="flex space-x-3">
                    <button 
                        id="toggle-theme-btn"
                        onclick="toggleTheme()"
                        class="p-2 rounded-full text-cyan-400 hover:bg-gray-700 transition duration-200 border border-transparent hover:border-gray-600 light-theme:hover:bg-blue-100 light-theme:text-blue-600"
                        aria-label="Cambiar tema"
                    >
                        <!-- Luna -->
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 12.001 12.001 0 0012 21a12.001 12.001 0 008.354-5.646z" />
                        </svg>
                        <!-- Sol -->
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>

                    <!-- Bot√≥n Reset (Borrar Todo) -->
                    <button 
                        onclick="openResetModal()"
                        class="bg-red-600/80 hover:bg-red-500 text-white p-2 rounded-xl shadow-lg transition duration-200 transform hover:scale-105 active:scale-95"
                        title="Borrar todos los datos y empezar de nuevo"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    
                    <button 
                        onclick="downloadExcel()"
                        class="bg-lime-500 hover:bg-lime-400 text-gray-900 font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200 flex items-center transform hover:scale-105 active:scale-95 text-sm md:text-base"
                        title="Descargar datos en formato CSV para Excel"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Descargar CSV
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabla de Inventario -->
        <div class="mt-4 overflow-x-auto">
            <table id="inventory-table">
                <thead>
                    <tr>
                        <th class="table-header text-left w-[75%] md:w-[80%] pl-4 sticky left-0 z-10">PRODUCTO</th>
                        <th class="table-header w-[25%] md:w-[20%]">CANTIDAD</th>
                    </tr>
                </thead>
                <tbody id="inventory-list">
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>

        <!-- Footer / Resumen -->
        <footer class="mt-8 pt-6 border-t-4 border-cyan-600 bg-gray-800 rounded-lg p-4 shadow-xl footer-container transition-colors">
            <div class="flex flex-col sm:flex-row items-start sm:items-stretch justify-between gap-6">
                
                <!-- Contador -->
                <div class="w-full sm:w-1/2 flex flex-col"> 
                    <p class="text-lg font-bold text-cyan-400 mb-2 accent-text uppercase">CANTIDAD DE PRODUCTOS :</p>
                    <div class="flex-grow bg-cyan-600/20 border border-cyan-600/50 rounded-xl p-4 flex items-center justify-center">
                        <span id="stocked-products-count" class="text-5xl font-extrabold text-cyan-400 light-theme:text-blue-600">0</span>
                    </div>
                </div>
                
                <!-- Inputs Responsables -->
                <div class="w-full sm:w-1/2 flex flex-col space-y-3 sm:pl-4 sm:border-l border-gray-600 light-theme:border-gray-300">
                    <div>
                        <label class="text-sm font-semibold text-gray-400 light-theme:text-gray-600 uppercase block mb-1">Responsable 1</label>
                        <input type="text" id="responsable-1" placeholder="Nombre y Apellido" class="w-full p-2 rounded border border-gray-600 bg-gray-900 text-white focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" oninput="updateReportHeaders()">
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-400 light-theme:text-gray-600 uppercase block mb-1">Responsable 2</label>
                        <input type="text" id="responsable-2" placeholder="Nombre y Apellido" class="w-full p-2 rounded border border-gray-600 bg-gray-900 text-white focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" oninput="updateReportHeaders()">
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Calculadora -->
    <div id="calculator-modal" class="modal-overlay" onclick="if(event.target === this) closeCalculator()">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-xs mx-4 transform transition-all border border-cyan-700 relative">
            <!-- Header Calc -->
            <div class="mb-4 text-center">
                <h2 class="text-lg font-bold text-cyan-400 leading-tight truncate px-2" id="calc-product-name">Producto</h2>
            </div>

            <!-- Pantalla -->
            <div class="bg-gray-900 p-3 mb-4 rounded-lg text-right border border-gray-700 shadow-inner">
                <div class="text-gray-500 text-xs h-4 mb-1 truncate" id="calc-history"></div>
                <div id="calc-display" class="text-white text-4xl font-mono font-bold truncate tracking-widest">0</div>
            </div>

            <!-- Teclado -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="clearCalculator()" class="col-span-1 bg-red-900/80 text-red-200 rounded-lg p-3 font-bold hover:bg-red-800">C</button>
                <button onclick="backspaceCalculator()" class="col-span-1 bg-red-900/80 text-red-200 rounded-lg p-3 font-bold hover:bg-red-800">‚å´</button>
                <button onclick="handleOperator('/')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">√∑</button>
                <button onclick="handleOperator('*')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">√ó</button>

                <button onclick="inputDigit('7')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">7</button>
                <button onclick="inputDigit('8')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">8</button>
                <button onclick="inputDigit('9')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">9</button>
                <button onclick="handleOperator('-')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">-</button>

                <button onclick="inputDigit('4')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">4</button>
                <button onclick="inputDigit('5')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">5</button>
                <button onclick="inputDigit('6')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">6</button>
                <button onclick="handleOperator('+')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">+</button>

                <button onclick="inputDigit('1')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">1</button>
                <button onclick="inputDigit('2')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">2</button>
                <button onclick="inputDigit('3')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">3</button>
                <button onclick="handleOperator('=')" class="row-span-2 bg-cyan-600 text-white rounded-lg p-3 font-bold hover:bg-cyan-500 shadow-lg flex items-center justify-center text-xl">=</button>

                <button onclick="inputDigit('0')" class="col-span-2 bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">0</button>
                <button onclick="inputDigit('.')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">.</button>
            </div>

            <!-- Botones Control -->
            <div class="flex space-x-2">
                <button onclick="closeCalculator()" class="flex-1 py-3 bg-gray-700 text-gray-300 rounded-xl font-semibold hover:bg-gray-600">Cancelar</button>
                <button onclick="saveAndClose()" class="flex-1 py-3 bg-lime-600 text-white rounded-xl font-bold hover:bg-lime-500 shadow-lg shadow-lime-900/20">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Borrar -->
    <div id="reset-modal" class="modal-overlay" onclick="if(event.target === this) closeResetModal()">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 transform transition-all border border-red-700">
            <h3 class="text-xl font-bold text-red-400 mb-4">‚ö†Ô∏è Confirmar Borrado Total</h3>
            <p class="text-gray-300 mb-6">Est√°s a punto de **eliminar todo el inventario** de la base de datos de forma permanente. Esta acci√≥n no se puede deshacer.</p>
            <p class="text-white font-semibold mb-6">¬øEst√°s absolutamente seguro de que deseas continuar?</p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeResetModal()" class="py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Cancelar</button>
                <button onclick="resetAllDataConfirmed()" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition shadow-lg">S√≠, Borrar Todo</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar funciones de Firestore
        import { doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATOS INICIALES Y ESTRUCTURA ---
        const productNames = [
            "CACHITOS ", "CATALINAS /NEGRAS* 10", "COCADAS", "GALLETA ARTESANAL ", 
            "PAN ARABE", "PAN CORTADITOS", "PAN DE GUAYABA", "PAN DE HAMBURGUESA X 08", 
            "PAN DE SANDWICHE  GRD", "PAN DE SANDWICHE  INTEGRAL ", "PAN DE SANDWICHE  PQ", "PAN DE SANDWIS NACIONAL 500GR", 
            "PAN DE TUNJA PEQ", "PANELA DULCE", "SOPA SOBRE MAGGY", 
        ];

        // Funci√≥n para generar la estructura de inventario inicial
        const getInitialInventoryData = () => productNames.map(name => ({
            name: name,
            quantity: 0,
            history: "0"
        }));

        // --- INICIALIZACI√ìN INMEDIATA ---
        // Inicializamos esto ANTES de cualquier llamada a la DB para que la tabla no est√© vac√≠a
        let inventoryData = getInitialInventoryData();
        let responsables = { resp1: "SIN NOMBRE", resp2: "SIN NOMBRE" };

        
        // --- FIREBASE: LECTURA EN TIEMPO REAL (onSnapshot) ---
        window.startRealtimeListener = () => {
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible.");
                return;
            }

            onSnapshot(window.inventoryRef, (docSnapshot) => {
                let data = docSnapshot.data();

                // Validaci√≥n extra: aseguramos que data.inventory no est√© vac√≠o
                if (docSnapshot.exists() && data && Array.isArray(data.inventory) && data.inventory.length > 0) {
                    // Datos encontrados y v√°lidos: Usar datos de Firestore
                    inventoryData = data.inventory;
                    responsables.resp1 = data.responsable1 || "SIN NOMBRE";
                    responsables.resp2 = data.responsable2 || "SIN NOMBRE";
                    console.log("Datos de Firestore cargados.");
                } else {
                    // Datos no encontrados O array vac√≠o: Inicializar y guardar en DB
                    console.log("Datos no encontrados o vac√≠os, reinicializando.");
                    inventoryData = getInitialInventoryData();
                    // Guardar la estructura inicial en la DB para corregir el problema persistente
                    saveInventoryData(); 
                }
                
                // 4. Actualizar toda la UI
                renderInventoryTable();
                updateReportHeaders(false); 
                calculateTotalItems();
            }, (error) => {
                console.error("Error al escuchar la base de datos:", error);
                // Incluso si falla, renderizamos lo local (que son ceros)
                renderInventoryTable();
            });
        };

        // --- FIREBASE: ESCRITURA (setDoc) ---
        window.saveInventoryData = async function() {
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible para guardar.");
                return;
            }
            try {
                const dataToSave = {
                    inventory: inventoryData,
                    responsable1: document.getElementById('responsable-1').value || "SIN NOMBRE",
                    responsable2: document.getElementById('responsable-2').value || "SIN NOMBRE",
                    lastUpdated: new Date().toISOString()
                };
                await setDoc(window.inventoryRef, dataToSave);
                console.log("Datos guardados en Firestore.");
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
            }
        }

        // --- FIREBASE: BORRADO (deleteDoc) ---
        window.resetAllDataConfirmed = async function() {
            closeResetModal();
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible para borrar.");
                return;
            }
            try {
                await deleteDoc(window.inventoryRef);
                console.log("Documento de inventario borrado.");
                // Al borrar, onSnapshot se disparar√°, no encontrar√° datos y ejecutar√° getInitialInventoryData() autom√°ticamente
            } catch (e) {
                console.error("Error al borrar el inventario:", e);
            }
        }

        // --- MANEJO DE UI Y DATOS LOCALES ---

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Renderizar INMEDIATAMENTE la tabla con ceros para que no se vea vac√≠a mientras carga
            renderInventoryTable();
            
            if(window.initFirebase) window.initFirebase(); // Iniciar Firebase
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        });

        window.renderInventoryTable = function() {
            const tbody = document.getElementById('inventory-list');
            if (!tbody) return;
            tbody.innerHTML = ''; 

            inventoryData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                const zeroClass = item.quantity === 0 ? 'zero-qty' : '';

                tr.innerHTML = `
                    <td class="table-data product-cell">${item.name}</td>
                    <td class="table-data qty-cell ${zeroClass}" 
                        onclick="openCalculator(${index}, '${item.name.replace(/'/g, "\\'")}')"
                        id="qty-cell-${index}">
                        <span id="qty-display-${index}" data-quantity="${item.quantity}" data-history="${item.history || '0'}">${item.quantity}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.updateReportHeaders = function(shouldSave = true) {
            const r1Input = document.getElementById('responsable-1');
            const r2Input = document.getElementById('responsable-2');
            
            // Si cargamos de la DB, actualizar inputs primero
            if (!shouldSave) {
                r1Input.value = responsables.resp1 === "SIN NOMBRE" ? "" : responsables.resp1;
                r2Input.value = responsables.resp2 === "SIN NOMBRE" ? "" : responsables.resp2;
            }

            const r1 = r1Input.value || "SIN NOMBRE";
            const r2 = r2Input.value || "SIN NOMBRE";

            document.getElementById('resp1-display').textContent = r1.toUpperCase();
            document.getElementById('resp2-display').textContent = r2.toUpperCase();
            
            if (shouldSave) {
                saveInventoryData(); // Guardar cambios de responsables en DB
            }
        }

        window.calculateTotalItems = function() {
            const count = inventoryData.filter(i => (parseFloat(i.quantity) || 0) > 0).length;
            document.getElementById('stocked-products-count').textContent = count;
        }

        // --- L√ìGICA DE CALCULADORA ---
        const calculator = {
            displayValue: '0',
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            currentProductIndex: null,
            fullExpression: '0',
            isResultCalculated: false,
        };

        window.openCalculator = function(index, productName) {
            calculator.currentProductIndex = index;
            document.getElementById('calc-product-name').innerText = productName;
            
            const currentQty = inventoryData[index].quantity;
            const currentHist = inventoryData[index].history || String(currentQty); 
            
            window.clearCalculator(false); 
            
            calculator.displayValue = String(currentQty);
            calculator.fullExpression = currentHist;
            calculator.firstOperand = parseFloat(currentQty);
            calculator.isResultCalculated = true; 

            window.updateDisplay();
            document.getElementById('calculator-modal').style.display = 'flex';
        }

        window.closeCalculator = function() {
            document.getElementById('calculator-modal').style.display = 'none';
            calculator.currentProductIndex = null;
        }

        window.updateDisplay = function() {
            const display = document.getElementById('calc-display');
            const history = document.getElementById('calc-history');
            
            display.textContent = calculator.displayValue;
            history.textContent = calculator.fullExpression;

            if(calculator.displayValue.length > 9) {
                display.style.fontSize = '1.5rem';
            } else {
                display.style.fontSize = '2.25rem';
            }
        }

        window.inputDigit = function(digit) {
            const { displayValue, waitingForSecondOperand, isResultCalculated } = calculator;

            if (isResultCalculated) {
                if (digit === '.') {
                    calculator.displayValue = '0.';
                    calculator.fullExpression = '0.';
                } else {
                    calculator.displayValue = digit;
                    calculator.fullExpression = digit;
                }
                calculator.isResultCalculated = false;
                calculator.firstOperand = null; 
                calculator.operator = null;
                calculator.waitingForSecondOperand = false; 

            } else if (digit === '.') {
                if (displayValue.includes('.')) return;
                if (waitingForSecondOperand) {
                     calculator.displayValue = '0.';
                     calculator.fullExpression += '0.';
                     calculator.waitingForSecondOperand = false;
                } else {
                    calculator.displayValue = displayValue + digit;
                    calculator.fullExpression += digit;
                }
            } else if (waitingForSecondOperand) {
                calculator.displayValue = digit;
                calculator.waitingForSecondOperand = false;
                calculator.fullExpression += digit;
            } else {
                if (displayValue === '0' && digit !== '0') {
                    calculator.displayValue = digit;
                    if (calculator.fullExpression.endsWith('0')) {
                         calculator.fullExpression = calculator.fullExpression.slice(0, -1) + digit;
                    } else {
                         calculator.fullExpression += digit;
                    }
                } else if (displayValue === '0' && digit === '0') {
                    return;
                } else {
                    calculator.displayValue = displayValue + digit;
                    calculator.fullExpression += digit;
                }
            }
            updateDisplay();
        }

        window.handleOperator = function(nextOperator) {
            if (nextOperator === '=') {
                if (calculator.operator && !calculator.waitingForSecondOperand) {
                    const inputValue = parseFloat(calculator.displayValue);
                    const result = calculate(calculator.firstOperand, inputValue, calculator.operator);
                    
                    calculator.displayValue = String(result);
                    calculator.firstOperand = result;
                    calculator.operator = null;
                    calculator.waitingForSecondOperand = false;
                    calculator.isResultCalculated = true;
                }
                updateDisplay();
                return;
            }

            const inputValue = parseFloat(calculator.displayValue);

            if (calculator.operator && calculator.waitingForSecondOperand) {
                calculator.operator = nextOperator;
                calculator.fullExpression = calculator.fullExpression.slice(0, -3) + ` ${nextOperator} `;
                updateDisplay();
                return;
            }

            if (calculator.firstOperand == null && !isNaN(inputValue)) {
                calculator.firstOperand = inputValue;
            } else if (calculator.operator) {
                const result = calculate(calculator.firstOperand, inputValue, calculator.operator);
                calculator.displayValue = String(result);
                calculator.firstOperand = result;
            }

            calculator.waitingForSecondOperand = true;
            calculator.operator = nextOperator;
            calculator.isResultCalculated = false;
            calculator.fullExpression += ` ${nextOperator} `;
            
            updateDisplay();
        }

        function calculate(first, second, operator) {
            if (operator === '+') return first + second;
            if (operator === '-') return first - second;
            if (operator === '*') return first * second;
            if (operator === '/') return second !== 0 ? parseFloat((first / second).toFixed(2)) : 'Error';
            return second;
        }

        window.clearCalculator = function(fullClear = true) {
            calculator.displayValue = '0';
            calculator.firstOperand = null;
            calculator.waitingForSecondOperand = false;
            calculator.operator = null;
            
            if (fullClear) {
                 calculator.fullExpression = '0';
                 calculator.isResultCalculated = false;
            }
            updateDisplay();
        }

        window.backspaceCalculator = function() {
            if (calculator.isResultCalculated) return;

            if (calculator.displayValue.length > 1) {
                calculator.displayValue = calculator.displayValue.slice(0, -1);
                calculator.fullExpression = calculator.fullExpression.slice(0, -1);
            } else {
                calculator.displayValue = '0';
                if (calculator.fullExpression.length > 0) {
                     calculator.fullExpression = calculator.fullExpression.slice(0, -1);
                }
                if (calculator.fullExpression === '') calculator.fullExpression = '0';
            }
            updateDisplay();
        }

        window.saveAndClose = function() {
            if (calculator.currentProductIndex === null) return;
            if (calculator.operator && !calculator.waitingForSecondOperand) {
                 window.handleOperator('=');
            }
            const finalValue = parseFloat(calculator.displayValue);
            const finalHistory = calculator.fullExpression;
            inventoryData[calculator.currentProductIndex].quantity = finalValue;
            inventoryData[calculator.currentProductIndex].history = finalHistory;
            window.saveInventoryData();
            window.renderInventoryTable();
            window.calculateTotalItems();
            window.closeCalculator();
        }
        
        // --- OTRAS UTILIDADES ---
        window.toggleTheme = function() {
            document.documentElement.classList.toggle('light-theme');
            const sun = document.getElementById('sun-icon');
            const moon = document.getElementById('moon-icon');
            if (document.documentElement.classList.contains('light-theme')) {
                moon.classList.add('hidden');
                sun.classList.remove('hidden');
            } else {
                sun.classList.add('hidden');
                moon.classList.remove('hidden');
            }
        }

        window.openResetModal = function() {
            document.getElementById('reset-modal').style.display = 'flex';
        }
        
        window.closeResetModal = function() {
            document.getElementById('reset-modal').style.display = 'none';
        }

        window.downloadExcel = function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Calcular cantidad de productos con stock (mayor a 0)
            const stockedCount = inventoryData.filter(i => (parseFloat(i.quantity) || 0) > 0).length;

            // Header
            csvContent += "RED CECOSESOLA - FERIA DEL ESTE\n";
            csvContent += `FECHA: ${document.getElementById('report-date').textContent}\n`;
            csvContent += `RESPONSABLE 1: ${document.getElementById('responsable-1').value}\n`;
            csvContent += `RESPONSABLE 2: ${document.getElementById('responsable-2').value}\n`;
            csvContent += `PRODUCTOS DE CONTADOS: ${stockedCount}\n\n`;
            
            // Table Header (HISTORIAL ANTES DE CANTIDAD)
            csvContent += "PRODUCTO,HISTORIAL,CANTIDAD\n";
            
            // Data
            inventoryData.forEach(row => {
                const history = row.history ? `"${row.history}"` : "";
                csvContent += `${row.name},${history},${row.quantity}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "inventario_panes.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
