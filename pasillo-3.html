<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVENTARIO DE VIVERES - PERSISTENCIA FIRESTORE</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importaciones de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales que ser√°n inicializadas al inicio
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.inventoryRef = null;

        // Configuraci√≥n y Inicializaci√≥n de Firebase
        const initFirebase = async () => {
            // =========================================================================
            //  --- ‚ö†Ô∏è ZONA DE CONFIGURACI√ìN DE FIREBASE (IMPORTANTE PARA GITHUB) ‚ö†Ô∏è ---
            //  Si est√°s ejecutando esto en GitHub, DEBES reemplazar el contenido de 
            //  'userFirebaseConfig' con tu propia configuraci√≥n de proyecto de Firebase.
            // =========================================================================
            const userFirebaseConfig = {
                apiKey: "TU_API_KEY_AQUI", // <-- REEMPLAZA ESTO
                authDomain: "TU_DOMINIO.firebaseapp.com",
                projectId: "TU_PROJECT_ID",
                storageBucket: "TU_BUCKET.appspot.com",
                messagingSenderId: "1234567890",
                appId: "1:1234567890:web:abcdefghij",
            };
            // =========================================================================

            let firebaseConfig = userFirebaseConfig; 
            let useCanvasAuth = false;
            let appId = 'standalone-app';

            try {
                // 1. Intentar usar la configuraci√≥n proporcionada por el Canvas si est√° disponible
                if (typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).projectId) {
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    useCanvasAuth = true;
                    console.log("Usando configuraci√≥n de Firebase del entorno Canvas.");
                } else if (firebaseConfig.apiKey === "TU_API_KEY_AQUI") {
                    // 2. Fallo si no hay config de Canvas y el usuario no puso su API Key
                    console.error("¬°ERROR! Falta la clave de API de Firebase. El guardado no funcionar√°. Por favor, edita la variable 'userFirebaseConfig'.");
                    document.getElementById('save-status').textContent = "ERROR: ¬°Falta la configuraci√≥n de Firebase! No se guardar√°n los datos.";
                    document.getElementById('save-status').className = `mt-3 text-center text-sm font-semibold h-4 text-red-400`;
                    return;
                }
            } catch (e) {
                console.error("Error al obtener config, usando la configuraci√≥n est√°tica:", e);
            }
            
            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                
                // 3. Autenticaci√≥n: Usar token de Canvas o An√≥nima como fallback
                if (useCanvasAuth && typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("Autenticaci√≥n con token de Canvas.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("Autenticaci√≥n An√≥nima (para GitHub/Local).");
                }

                // Esperar a que el estado de autenticaci√≥n cambie y obtener el userId
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        
                        // Definir la referencia del documento: 
                        // Canvas Path: /artifacts/{appId}/users/{userId}/panes_inventory/current_data
                        // GitHub Path (usando tu propia regla): users/{userId}/panes_inventory/current_data
                        const collectionPath = useCanvasAuth 
                            ? `/artifacts/${appId}/users/${window.currentUserId}/panes_inventory`
                            : `users/${window.currentUserId}/panes_inventory`;
                        
                        window.inventoryRef = doc(window.db, collectionPath, 'current_data');

                        // Iniciar la escucha en tiempo real (onSnapshot)
                        if (window.startRealtimeListener) {
                            window.startRealtimeListener();
                        }
                    } else {
                        // Si falla la auth, usamos un ID temporal (pero no podemos guardar en DB sin un 'user')
                        window.currentUserId = crypto.randomUUID(); 
                    }
                });

            } catch (e) {
                console.error("Error en la inicializaci√≥n de Firebase:", e);
                document.getElementById('save-status').textContent = `ERROR: Fallo al inicializar Firebase. (${e.message})`;
                document.getElementById('save-status').className = `mt-3 text-center text-sm font-semibold h-4 text-red-400`;
            }
        };

        // Exportar initFirebase para usarlo en el script principal
        window.initFirebase = initFirebase;
    </script>
    <style>
        /* --- CONFIGURACI√ìN DE VARIABLES Y TEMA --- */
        :root {
            --neon-cyan: #22d3ee;
            --neon-lime: #a3e635;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #e5e7eb;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Utilidades */
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .neon-title { text-shadow: 0 0 5px rgba(34, 211, 238, 0.8); }
        
        /* --- ESTILOS DE TABLA (Simulaci√≥n Excel) --- */
        #inventory-table {
            border-collapse: separate; 
            border-spacing: 0;
            width: 100%;
            border: 1px solid #374151;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
        }
        
        .table-header, .table-data {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
        }

        .table-header {
            background-color: #1f2937;
            color: var(--neon-cyan);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .table-row { transition: background-color 0.2s; }
        .table-row:last-child .table-data { border-bottom: none; }
        
        /* Modo Oscuro (Default) */
        .table-row:hover { background-color: #1f2937; }
        
        .product-cell {
            font-size: 0.95rem;
            color: #e5e7eb;
            border-right: 1px solid #374151;
        }

        .qty-cell {
            text-align: center;
            font-weight: bold;
            color: var(--neon-lime);
            background-color: rgba(17, 24, 39, 0.5);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .qty-cell:hover {
            background-color: #374151;
            text-decoration: underline;
        }
        .zero-qty { color: #9ca3af !important; }

        /* --- TEMA CLARO --- */
        .light-theme body { background-color: #f3f4f6; color: #1f2937; }
        .light-theme .main-container { background-color: #ffffff; border-color: #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .light-theme .neon-title { color: #2563eb; text-shadow: none; }
        .light-theme .accent-text { color: #2563eb; }
        
        /* Tabla Claro */
        .light-theme #inventory-table { border-color: #e5e7eb; }
        .light-theme .table-header { background-color: #bfdbfe; color: #1e40af; border-bottom: 1px solid #93c5fd; }
        .light-theme .table-data { border-bottom: 1px solid #e5e7eb; }
        .light-theme .product-cell { color: #1f2937; border-right: 1px solid #e5e7eb; }
        .light-theme .table-row:hover { background-color: #f0f9ff; }
        .light-theme .qty-cell { background-color: #ecfdf5; color: #059669; }
        .light-theme .qty-cell:hover { background-color: #d1fae5; }
        .light-theme .zero-qty { color: #6b7280 !important; }

        /* Inputs y Footer Claro */
        .light-theme input[type="text"] { background-color: #ffffff; border-color: #94a3b8; color: #0f172a; }
        .light-theme .footer-container { background-color: #e2e8f0; border-color: #94a3b8; }

        /* Estilos de Status (OCULTO AHORA, pero si se necesitara en el futuro) */
        .text-lime-400 { color: var(--neon-lime); }
        .text-red-400 { color: #f87171; }
        .light-theme .text-lime-600 { color: #16a34a; }
        .light-theme .text-red-600 { color: #dc2626; }
    </style>
</head>
<body class="p-2 md:p-6 min-h-screen">

    <div class="max-w-4xl mx-auto bg-gray-900 p-4 md:p-8 rounded-2xl shadow-2xl border border-cyan-900 main-container">
        <header class="mb-4">
            <!-- Cabecera tipo Reporte -->
            <div class="border border-gray-700 p-4 rounded-xl mb-3 bg-gray-800/50 light-theme:bg-white light-theme:border-blue-200 transition-colors">
                <!-- Fila 1: ORGANISMO Y FECHA -->
                <div class="flex flex-col md:flex-row justify-between md:items-center border-b border-gray-700 pb-2 mb-2 light-theme:border-gray-200">
                    <p class="text-xs font-bold text-cyan-400 light-theme:text-blue-600 tracking-wide mb-1 md:mb-0">ORGANISMO DE INTEGRACI√ìN COOPERATIVA CECOSESOLA, R.L. J085030140</p>
                    <p class="text-xs text-gray-400 light-theme:text-gray-500">FECHA: <span id="report-date" class="font-semibold text-gray-200 light-theme:text-gray-800"></span></p>
                </div>
                
                <!-- Fila 2: PASILLO Y RESPONSABLES -->
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div class="mb-2 md:mb-0">
                        <h2 class="text-2xl md:text-3xl font-extrabold text-cyan-400 neon-title light-theme:text-blue-700 uppercase">üçû PASILLO PANES (PERSISTENTE) üçû</h2>
                        <h3 class="text-lg font-bold text-gray-300 light-theme:text-gray-600">FERIA DEL ESTE</h3>
                    </div>
                    
                    <div class="text-sm w-full md:w-auto bg-gray-900/50 p-2 rounded light-theme:bg-gray-100">
                        <p class="text-gray-400 light-theme:text-gray-500 mb-1">RESPONSABLE 1: <span id="resp1-display" class="font-semibold text-white light-theme:text-gray-800 uppercase">SIN NOMBRE</span></p>
                        <p class="text-gray-400 light-theme:text-gray-500">RESPONSABLE 2: <span id="resp2-display" class="font-semibold text-white light-theme:text-gray-800 uppercase">SIN NOMBRE</span></p>
                    </div>
                </div>
            </div>

            <!-- MENSAJE DE ESTADO DE GUARDADO -->
            <p id="save-status" class="mt-3 text-center text-sm font-semibold h-4"></p>

            <!-- Botones de Acci√≥n -->
            <div class="flex justify-end space-x-3 items-center sticky top-2 z-10 bg-gray-900/90 p-2 rounded-xl backdrop-blur-sm light-theme:bg-white/90">
                <div class="flex space-x-3">
                    <button 
                        id="toggle-theme-btn"
                        onclick="toggleTheme()"
                        class="p-2 rounded-full text-cyan-400 hover:bg-gray-700 transition duration-200 border border-transparent hover:border-gray-600 light-theme:hover:bg-blue-100 light-theme:text-blue-600"
                        aria-label="Cambiar tema"
                    >
                        <!-- Luna -->
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 12.001 12.001 0 0012 21a12.001 12.001 0 008.354-5.646z" />
                        </svg>
                        <!-- Sol -->
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>

                    <!-- Bot√≥n Reset (Borrar Todo) -->
                    <button 
                        onclick="openResetModal()"
                        class="bg-red-600/80 hover:bg-red-500 text-white p-2 rounded-xl shadow-lg transition duration-200 transform hover:scale-105 active:scale-95"
                        title="Borrar todos los datos y empezar de nuevo"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    
                    <button 
                        onclick="downloadExcel()"
                        class="bg-lime-500 hover:bg-lime-400 text-gray-900 font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200 flex items-center transform hover:scale-105 active:scale-95 text-sm md:text-base"
                        title="Descargar datos en formato CSV para Excel"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Descargar CSV
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabla de Inventario -->
        <div class="mt-4 overflow-x-auto">
            <table id="inventory-table">
                <thead>
                    <tr>
                        <th class="table-header text-left w-[75%] md:w-[80%] pl-4 sticky left-0 z-10">PRODUCTO</th>
                        <th class="table-header w-[25%] md:w-[20%]">CANTIDAD</th>
                    </tr>
                </thead>
                <tbody id="inventory-list">
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>

        <!-- Footer / Resumen -->
        <footer class="mt-8 pt-6 border-t-4 border-cyan-600 bg-gray-800 rounded-lg p-4 shadow-xl footer-container transition-colors">
            <div class="flex flex-col sm:flex-row items-start sm:items-stretch justify-between gap-6">
                
                <!-- Contador -->
                <div class="w-full sm:w-1/2 flex flex-col"> 
                    <p class="text-lg font-bold text-cyan-400 mb-2 accent-text uppercase">CANTIDAD DE PRODUCTOS :</p>
                    <div class="flex-grow bg-cyan-600/20 border border-cyan-600/50 rounded-xl p-4 flex items-center justify-center">
                        <span id="stocked-products-count" class="text-5xl font-extrabold text-cyan-400 light-theme:text-blue-600">0</span>
                    </div>
                </div>
                
                <!-- Inputs Responsables -->
                <div class="w-full sm:w-1/2 flex flex-col space-y-3 sm:pl-4 sm:border-l border-gray-600 light-theme:border-gray-300">
                    <div>
                        <label class="text-sm font-semibold text-gray-400 light-theme:text-gray-600 uppercase block mb-1">Responsable 1</label>
                        <input type="text" id="responsable-1" placeholder="Nombre y Apellido" class="w-full p-2 rounded border border-gray-600 bg-gray-900 text-white focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" oninput="updateReportHeaders()">
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-400 light-theme:text-gray-600 uppercase block mb-1">Responsable 2</label>
                        <input type="text" id="responsable-2" placeholder="Nombre y Apellido" class="w-full p-2 rounded border border-gray-600 bg-gray-900 text-white focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" oninput="updateReportHeaders()">
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Calculadora -->
    <div id="calculator-modal" class="modal-overlay" onclick="if(event.target === this) closeCalculator()">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-xs mx-4 transform transition-all border border-cyan-700 relative">
            <!-- Header Calc -->
            <div class="mb-4 text-center">
                <h2 class="text-lg font-bold text-cyan-400 leading-tight truncate px-2" id="calc-product-name">Producto</h2>
            </div>

            <!-- Pantalla -->
            <div class="bg-gray-900 p-3 mb-4 rounded-lg text-right border border-gray-700 shadow-inner">
                <div class="text-gray-500 text-xs h-4 mb-1 truncate" id="calc-history"></div>
                <div id="calc-display" class="text-white text-4xl font-mono font-bold truncate tracking-widest">0</div>
            </div>

            <!-- Teclado -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="clearCalculator()" class="col-span-1 bg-red-900/80 text-red-200 rounded-lg p-3 font-bold hover:bg-red-800">C</button>
                <button onclick="backspaceCalculator()" class="col-span-1 bg-red-900/80 text-red-200 rounded-lg p-3 font-bold hover:bg-red-800">‚å´</button>
                <button onclick="handleOperator('/')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">√∑</button>
                <button onclick="handleOperator('*')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">√ó</button>

                <button onclick="inputDigit('7')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">7</button>
                <button onclick="inputDigit('8')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">8</button>
                <button onclick="inputDigit('9')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">9</button>
                <button onclick="handleOperator('-')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">-</button>

                <button onclick="inputDigit('4')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">4</button>
                <button onclick="inputDigit('5')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">5</button>
                <button onclick="inputDigit('6')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">6</button>
                <button onclick="handleOperator('+')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">+</button>

                <button onclick="inputDigit('1')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">1</button>
                <button onclick="inputDigit('2')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">2</button>
                <button onclick="inputDigit('3')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">3</button>
                <button onclick="handleOperator('=')" class="row-span-2 bg-cyan-600 text-white rounded-lg p-3 font-bold hover:bg-cyan-500 shadow-lg flex items-center justify-center text-xl">=</button>

                <button onclick="inputDigit('0')" class="col-span-2 bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">0</button>
                <button onclick="inputDigit('.')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">.</button>
            </div>

            <!-- Botones Control -->
            <div class="flex space-x-2">
                <button onclick="closeCalculator()" class="flex-1 py-3 bg-gray-700 text-gray-300 rounded-xl font-semibold hover:bg-gray-600">Cancelar</button>
                <button onclick="saveAndClose()" class="flex-1 py-3 bg-lime-600 text-white rounded-xl font-bold hover:bg-lime-500 shadow-lg shadow-lime-900/20">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Borrar -->
    <div id="reset-modal" class="modal-overlay" onclick="if(event.target === this) closeResetModal()">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 transform transition-all border border-red-700">
            <h3 class="text-xl font-bold text-red-400 mb-4">‚ö†Ô∏è Confirmar Borrado Total</h3>
            <p class="text-gray-300 mb-6">Est√°s a punto de **eliminar todo el inventario** de la base de datos de forma permanente. Esta acci√≥n no se puede deshacer.</p>
            <p class="text-white font-semibold mb-6">¬øEst√°s absolutamente seguro de que deseas continuar?</p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeResetModal()" class="py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Cancelar</button>
                <button onclick="resetAllDataConfirmed()" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition shadow-lg">S√≠, Borrar Todo</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar funciones de Firestore
        import { doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATOS INICIALES Y ESTRUCTURA ---
        const productNames = [
            "CACHITOS ", "CATALINAS /NEGRAS* 10", "COCADAS", "GALLETA ARTESANAL ", 
            "PAN ARABE", "PAN CORTADITOS", "PAN DE GUAYABA", "PAN DE HAMBURGUESA X 08", 
            "PAN DE SANDWICHE GRD", "PAN DE SANDWICHE INTEGRAL ", "PAN DE SANDWICHE PQ", "PAN DE SANDWIS NACIONAL 500GR", 
            "PAN DE TUNJA PEQ", "PANELA DULCE", "SOPA SOBRE MAGGY", 
        ];

        // Referencia al elemento de estado (mantenido por si es necesario para debugging)
        const saveStatusElement = document.getElementById('save-status');

        // Funci√≥n para mostrar mensajes de estado temporalmente (ahora solo para errores de DB)
        function showStatus(message, color) {
            if (!saveStatusElement) return;
            
            saveStatusElement.textContent = message;
            saveStatusElement.className = `mt-3 text-center text-sm font-semibold h-4 text-${color}-400 light-theme:text-${color}-600`;
            
            setTimeout(() => {
                saveStatusElement.textContent = '';
                saveStatusElement.className = `mt-3 text-center text-sm font-semibold h-4`;
            }, 5000); // Mostrar errores por 5 segundos
        }

        // Funci√≥n para generar la estructura de inventario inicial
        const getInitialInventoryData = () => productNames.map(name => ({
            name: name,
            quantity: 0,
            history: "0"
        }));

        // --- INICIALIZACI√ìN INMEDIATA ---
        let inventoryData = getInitialInventoryData();
        let responsables = { resp1: "SIN NOMBRE", resp2: "SIN NOMBRE" };

        
        // --- FIREBASE: LECTURA EN TIEMPO REAL (onSnapshot) ---
        window.startRealtimeListener = () => {
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible.");
                showStatus("Error interno: No se pudo conectar a la DB (ref. no lista).", 'red');
                return; 
            }

            onSnapshot(window.inventoryRef, (docSnapshot) => {
                let data = docSnapshot.data();
                let shouldSaveInitial = false;

                // VALIDACI√ìN MEJORADA para evitar la sobreescritura de datos
                if (docSnapshot.exists() && data && Array.isArray(data.inventory) && data.inventory.length > 0) {
                    // Datos encontrados y v√°lidos: Usar datos de Firestore
                    inventoryData = data.inventory;
                    responsables.resp1 = data.responsable1 || "SIN NOMBRE";
                    responsables.resp2 = data.responsable2 || "SIN NOMBRE";
                    console.log("Datos de Firestore cargados exitosamente.");
                    showStatus("Datos cargados. La persistencia est√° activa.", 'lime');
                } else if (docSnapshot.exists() && data && data.inventory && data.inventory.length === 0) {
                    // Documento existe pero la lista de inventario est√° vac√≠a (posible borrado manual o error)
                    console.warn("Documento existe pero inventario vac√≠o. Reinicializando a cero.");
                    inventoryData = getInitialInventoryData();
                    shouldSaveInitial = true; // Guardar la estructura base con 0s
                } else {
                    // Documento no existe: Inicializar a cero y guardar la estructura base
                    console.warn("Documento de inventario inexistente. Inicializando a cero y creando estructura base.");
                    inventoryData = getInitialInventoryData();
                    shouldSaveInitial = true; // Guardar la estructura base con 0s
                }

                // Si debe guardar la estructura inicial, lo hacemos aqu√≠ de forma as√≠ncrona.
                if (shouldSaveInitial) {
                    window.saveInventoryData(false); 
                }
                
                // 4. Actualizar toda la UI con los datos cargados o inicializados
                renderInventoryTable();
                updateReportHeaders(false); // Cargar datos de responsables en los inputs
                calculateTotalItems();
            }, (error) => {
                console.error("Error al escuchar la base de datos:", error);
                showStatus("Error de conexi√≥n con Firestore. Revisa tu configuraci√≥n/conexi√≥n.", 'red');
                // En caso de fallo, al menos renderizamos lo local
                renderInventoryTable();
            });
        };

        // --- FIREBASE: ESCRITURA (setDoc) ---
        window.saveInventoryData = async function(explicitSave = false) {
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible para guardar.");
                showStatus("Error interno: No se pudo conectar a la DB para guardar.", 'red');
                return;
            }
            try {
                // Obtener los nombres de los responsables desde los inputs antes de guardar
                const r1Value = document.getElementById('responsable-1').value || "SIN NOMBRE";
                const r2Value = document.getElementById('responsable-2').value || "SIN NOMBRE";
                
                const dataToSave = {
                    inventory: inventoryData,
                    responsable1: r1Value,
                    responsable2: r2Value,
                    lastUpdated: new Date().toISOString()
                };
                
                // Usamos setDoc para sobrescribir el documento completo con el estado actual
                await setDoc(window.inventoryRef, dataToSave);
                console.log("Datos guardados en Firestore silenciosamente.");
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
                showStatus(`Error al guardar: ${e.message}`, 'red');
            }
        }

        // --- FIREBASE: BORRADO (deleteDoc) ---
        window.resetAllDataConfirmed = async function() {
            closeResetModal();
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible para borrar.");
                showStatus("Error: No se pudo borrar (DB no disponible).", 'red');
                return;
            }
            try {
                // Borrar el documento
                await deleteDoc(window.inventoryRef);
                console.log("Documento de inventario borrado. Reiniciando inventario.");
                showStatus("Inventario borrado y reiniciado.", 'lime');
                // onSnapshot se disparar√° y recrear√° el documento con ceros.
            } catch (e) {
                console.error("Error al borrar el inventario:", e);
                showStatus(`Error al borrar: ${e.message}`, 'red');
            }
        }

        // --- MANEJO DE UI Y DATOS LOCALES ---

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar configuraci√≥n local (Tema)
            loadLocalConfig();

            // Renderizar INMEDIATAMENTE la tabla con ceros para que no se vea vac√≠a mientras carga
            renderInventoryTable();
            
            if(window.initFirebase) window.initFirebase(); // Iniciar Firebase
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        });

        // Funci√≥n para cargar datos del LocalStorage (solo el tema, los responsables vienen de Firestore)
        function loadLocalConfig() {
            // Cargar Tema
            const storedTheme = localStorage.getItem('app_theme');
            const sun = document.getElementById('sun-icon');
            const moon = document.getElementById('moon-icon');

            if (storedTheme === 'light') {
                document.documentElement.classList.add('light-theme');
                moon.classList.add('hidden');
                sun.classList.remove('hidden');
            }
            // NOTA: Los responsables y el inventario se cargan **siempre** desde Firestore, no desde localStorage.
        }
        
        window.renderInventoryTable = function() {
            const tbody = document.getElementById('inventory-list');
            if (!tbody) return;
            tbody.innerHTML = ''; 

            inventoryData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                // Asegurar que quantity sea un n√∫mero o cero para la validaci√≥n
                const qtyValue = parseFloat(item.quantity) || 0;
                const zeroClass = qtyValue === 0 ? 'zero-qty' : '';

                tr.innerHTML = `
                    <td class="table-data product-cell">${item.name}</td>
                    <td class="table-data qty-cell ${zeroClass}" 
                        onclick="openCalculator(${index}, '${item.name.replace(/'/g, "\\'")}')"
                        id="qty-cell-${index}">
                        <span id="qty-display-${index}" data-quantity="${qtyValue}" data-history="${item.history || String(qtyValue)}">${qtyValue}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.updateReportHeaders = function(shouldSave = true) {
            const r1Input = document.getElementById('responsable-1');
            const r2Input = document.getElementById('responsable-2');
            
            // Si cargamos de la DB (shouldSave=false), actualizar inputs desde la variable global 'responsables'
            if (!shouldSave) {
                r1Input.value = responsables.resp1 === "SIN NOMBRE" ? "" : responsables.resp1;
                r2Input.value = responsables.resp2 === "SIN NOMBRE" ? "" : responsables.resp2;
            }

            const r1 = r1Input.value || "SIN NOMBRE";
            const r2 = r2Input.value || "SIN NOMBRE";

            // Actualizar vista
            document.getElementById('resp1-display').textContent = r1.toUpperCase();
            document.getElementById('resp2-display').textContent = r2.toUpperCase();
            
            if (shouldSave) {
                // Guardar cambios de responsables en DB (Guardado Silencioso)
                saveInventoryData(false); 
            }
        }

        window.calculateTotalItems = function() {
            const count = inventoryData.filter(i => (parseFloat(i.quantity) || 0) > 0).length;
            document.getElementById('stocked-products-count').textContent = count;
        }

        // --- L√ìGICA DE CALCULADORA ---
        const calculator = {
            displayValue: '0',
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            currentProductIndex: null,
            fullExpression: '0',
            isResultCalculated: false,
        };

        window.openCalculator = function(index, productName) {
            calculator.currentProductIndex = index;
            document.getElementById('calc-product-name').innerText = productName;
            
            const currentQty = inventoryData[index].quantity;
            const currentHist = inventoryData[index].history || String(currentQty); 
            
            window.clearCalculator(false); 
            
            calculator.displayValue = String(currentQty);
            calculator.fullExpression = currentHist;
            calculator.firstOperand = parseFloat(currentQty);
            calculator.isResultCalculated = true; // Simula que el valor actual es el resultado de la √∫ltima operaci√≥n

            window.updateDisplay();
            document.getElementById('calculator-modal').style.display = 'flex';
        }

        window.closeCalculator = function() {
            document.getElementById('calculator-modal').style.display = 'none';
            calculator.currentProductIndex = null;
        }

        window.updateDisplay = function() {
            const display = document.getElementById('calc-display');
            const history = document.getElementById('calc-history');
            
            // Asegura que displayValue sea un string
            let displayStr = String(calculator.displayValue);

            // Redondeo visual si es muy largo
            if (displayStr.length > 15) {
                displayStr = parseFloat(displayStr).toFixed(10);
            }
            
            display.textContent = displayStr;
            history.textContent = calculator.fullExpression;

            // Ajuste de tama√±o de fuente para n√∫meros largos
            if(displayStr.length > 9) {
                display.style.fontSize = '1.5rem';
            } else {
                display.style.fontSize = '2.25rem';
            }
        }

        window.inputDigit = function(digit) {
            const { displayValue, waitingForSecondOperand, isResultCalculated } = calculator;

            if (isResultCalculated) {
                if (digit === '.') {
                    calculator.displayValue = '0.';
                    calculator.fullExpression = '0.';
                } else {
                    calculator.displayValue = digit;
                    calculator.fullExpression = digit;
                }
                calculator.isResultCalculated = false;
                calculator.firstOperand = null; 
                calculator.operator = null;
                calculator.waitingForSecondOperand = false; 
            } else if (digit === '.') {
                if (displayValue.includes('.')) return;
                if (waitingForSecondOperand) {
                    calculator.displayValue = '0.';
                    calculator.fullExpression += '0.';
                    calculator.waitingForSecondOperand = false;
                } else if (displayValue === '0' && calculator.operator) {
                    calculator.displayValue = '0.';
                    calculator.fullExpression += '0.';
                } else {
                    calculator.displayValue += digit;
                    calculator.fullExpression += digit;
                }
            } else {
                if (waitingForSecondOperand) {
                    calculator.displayValue = digit;
                    calculator.fullExpression += digit;
                    calculator.waitingForSecondOperand = false;
                } else {
                    if (displayValue === '0' || displayValue === '-0') {
                        calculator.displayValue = digit;
                        // L√≥gica para reemplazar '0' al inicio de la expresi√≥n o despu√©s de un operador
                        const lastOpIndex = calculator.fullExpression.search(/[+\-*/](?=\d+$)/);
                        if (lastOpIndex !== -1 && calculator.fullExpression.slice(lastOpIndex + 1) === '0') {
                            calculator.fullExpression = calculator.fullExpression.slice(0, -1) + digit;
                        } else if (calculator.fullExpression === '0') {
                            calculator.fullExpression = digit;
                        } else {
                            calculator.fullExpression += digit;
                        }
                    } else {
                        calculator.fullExpression += digit;
                    }
                }
            }
            updateDisplay();
        }


        const performCalculation = {
            '/': (firstOperand, secondOperand) => secondOperand === 0 ? NaN : firstOperand / secondOperand,
            '*': (firstOperand, secondOperand) => firstOperand * secondOperand,
            '+': (firstOperand, secondOperand) => firstOperand + secondOperand,
            '-': (firstOperand, secondOperand) => firstOperand - secondOperand,
        };

        window.handleOperator = function(nextOperator) {
            const { firstOperand, displayValue, operator } = calculator;
            const inputValue = parseFloat(displayValue);

            if (nextOperator === '=') {
                if (operator === null) {
                    // Si '=' es presionado sin un operador, la expresi√≥n es el display
                    calculator.isResultCalculated = true;
                    updateDisplay();
                    return;
                }
                
                // Si tenemos un operador, pero el segundo operando no ha sido escrito a√∫n, no hacer nada.
                if (calculator.waitingForSecondOperand) return;
            }


            if (firstOperand === null && !isNaN(inputValue)) {
                calculator.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstOperand, inputValue);
                
                // Usamos un redondeo simple para evitar problemas de precisi√≥n de JS
                const roundedResult = Math.round(result * 100000) / 100000; 

                calculator.displayValue = String(roundedResult);
                calculator.firstOperand = roundedResult;
                
                if (nextOperator === '=') {
                    // C√°lculo de resultado final
                    calculator.fullExpression += ' = ' + roundedResult;
                    calculator.operator = null;
                    calculator.waitingForSecondOperand = false;
                    calculator.isResultCalculated = true;
                    updateDisplay();
                    return;
                }
            }

            calculator.waitingForSecondOperand = true;
            calculator.operator = nextOperator;
            
            if(nextOperator !== '=') {
                // Prevenir agregar operador si ya es lo √∫ltimo en la cadena de expresi√≥n
                if (!['+', '-', '*', '/'].includes(calculator.fullExpression.slice(-1))) {
                    calculator.fullExpression += nextOperator;
                } else {
                    // Si ya hay un operador, reemplazarlo
                    calculator.fullExpression = calculator.fullExpression.slice(0, -1) + nextOperator;
                }
            }
            
            updateDisplay();
        }


        window.clearCalculator = function(fullClear = true) {
            if (fullClear) {
                calculator.displayValue = '0';
                calculator.fullExpression = '0';
                calculator.firstOperand = null;
                calculator.waitingForSecondOperand = false;
                calculator.operator = null;
                calculator.isResultCalculated = false;
            } else {
                // Limpiar solo la visualizaci√≥n, mantener la expresi√≥n/historial para contexto
                calculator.displayValue = '0';
            }
            updateDisplay();
        }

        window.backspaceCalculator = function() {
            const { displayValue, fullExpression, isResultCalculated } = calculator;

            if (isResultCalculated) return; // No se puede borrar un resultado

            // 1. Manejar Full Expression (m√°s complejo, pero m√°s importante)
            let newFullExpression = fullExpression;

            // Retroceder en la expresi√≥n completa
            if (newFullExpression.length > 0) {
                newFullExpression = newFullExpression.slice(0, -1);
            }
            if (newFullExpression === '') {
                newFullExpression = '0';
            }
            calculator.fullExpression = newFullExpression;

            // 2. Manejar Display Value
            if (displayValue.length > 1 && displayValue !== '0') {
                calculator.displayValue = displayValue.slice(0, -1);
            } else if (displayValue.length === 1 || (displayValue.length === 2 && displayValue.startsWith('-'))) {
                calculator.displayValue = '0';
            }
            
            // 3. Revisar si borramos un operador y ajustar el estado
            if (['+', '-', '*', '/'].includes(fullExpression.slice(-1)) && !['+', '-', '*', '/'].includes(newFullExpression.slice(-1))) {
                calculator.operator = null;
                calculator.waitingForSecondOperand = false;
                // Intentar recalcular el firstOperand
                const lastNumMatch = newFullExpression.match(/[\d.]+$/);
                if(lastNumMatch) {
                    calculator.firstOperand = parseFloat(lastNumMatch[0]);
                    calculator.displayValue = lastNumMatch[0];
                } else {
                    calculator.firstOperand = parseFloat(newFullExpression) || 0;
                }
            } else if (calculator.waitingForSecondOperand && !calculator.operator) {
                 // Si borramos el display sin operador, ajustamos el waiting flag
                 calculator.waitingForSecondOperand = false;
            }


            updateDisplay();
        }

        window.saveAndClose = function() {
            if (calculator.currentProductIndex === null) {
                closeCalculator();
                return;
            }
            
            // 1. Calcular el resultado final si hay una expresi√≥n pendiente
            if (calculator.operator && !calculator.waitingForSecondOperand) {
                 handleOperator('=');
            }

            // 2. Obtener el valor final y el historial
            const finalQuantity = parseFloat(calculator.displayValue) || 0;
            // Remover ' = resultado' del historial si existe (resultado de handleOperator('='))
            const finalHistory = calculator.fullExpression.replace(/ = .*$/, ''); 

            // 3. Actualizar la estructura de datos local
            inventoryData[calculator.currentProductIndex].quantity = finalQuantity;
            inventoryData[calculator.currentProductIndex].history = finalHistory;

            // 4. Activar el guardado en DB (Guardado Silencioso)
            saveInventoryData(true);

            // 5. Actualizar UI localmente (onSnapshot tambi√©n lo har√°, pero esto da feedback instant√°neo)
            const qtyDisplay = document.getElementById(`qty-display-${calculator.currentProductIndex}`);
            if (qtyDisplay) {
                qtyDisplay.textContent = finalQuantity;
                const parentCell = qtyDisplay.parentElement;
                if (finalQuantity === 0) {
                    parentCell.classList.add('zero-qty');
                } else {
                    parentCell.classList.remove('zero-qty');
                }
            }
            calculateTotalItems();

            // 6. Cerrar Modal
            closeCalculator();
        }

        // --- UTILIDADES ---

        window.openResetModal = function() {
            document.getElementById('reset-modal').style.display = 'flex';
        }

        window.closeResetModal = function() {
            document.getElementById('reset-modal').style.display = 'none';
        }

        window.toggleTheme = function() {
            const isDark = !document.documentElement.classList.toggle('light-theme');
            const sun = document.getElementById('sun-icon');
            const moon = document.getElementById('moon-icon');

            if (isDark) {
                localStorage.setItem('app_theme', 'dark');
                moon.classList.remove('hidden');
                sun.classList.add('hidden');
            } else {
                localStorage.setItem('app_theme', 'light');
                moon.classList.add('hidden');
                sun.classList.remove('hidden');
            }
        }
        
        window.downloadExcel = function() {
            const dataToExport = inventoryData.map(item => ({
                Producto: item.name,
                Cantidad: item.quantity,
                Formula: item.history || item.quantity.toString()
            }));

            // Agregar responsables y fecha al inicio del CSV
            const date = new Date().toLocaleDateString('es-ES');
            const r1 = document.getElementById('responsable-1').value || "SIN NOMBRE";
            const r2 = document.getElementById('responsable-2').value || "SIN NOMBRE";

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Metadatos
            csvContent += `INVENTARIO PANES,FECHA,${date}\n`;
            csvContent += `RESPONSABLE 1,${r1}\n`;
            csvContent += `RESPONSABLE 2,${r2}\n\n`;

            // Encabezados
            const headers = Object.keys(dataToExport[0]);
            csvContent += headers.join(',') + '\n';

            // Filas de datos
            dataToExport.forEach(item => {
                const row = headers.map(header => {
                    let value = item[header];
                    // Sanitizar valores (eliminar comas, envolver strings con comillas si contienen comas)
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""'); // Escapar comillas dobles
                        if (value.includes(',')) {
                            value = `"${value}"`;
                        }
                    }
                    return value;
                }).join(',');
                csvContent += row + '\n';
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventario_panes_${date.replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
