<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚òïINVENTARIO DE VIVERES PASILLO 2 CAFE ‚òï </title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importaciones de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales que ser√°n inicializadas al inicio
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.inventoryRef = null;

        // Configuraci√≥n y Inicializaci√≥n de Firebase
        const initFirebase = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig;
            try {
                firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            } catch (e) {
                console.error("Error al parsear __firebase_config:", e);
                return;
            }

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("La configuraci√≥n de Firebase est√° vac√≠a.");
                return;
            }

            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                // setLogLevel('Debug'); // Descomentar para depuraci√≥n

                // Autenticaci√≥n usando el token o an√≥nima
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Esperar a que el estado de autenticaci√≥n cambie y obtener el userId
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        console.log("Usuario autenticado:", window.currentUserId);
                        
                        // Definir la referencia del documento: /artifacts/{appId}/users/{userId}/cafe_inventory/current_data
                        const collectionPath = `/artifacts/${appId}/users/${window.currentUserId}/cafe_inventory`;
                        window.inventoryRef = doc(window.db, collectionPath, 'current_data');

                        // 3. Iniciar la escucha en tiempo real (onSnapshot)
                        window.startRealtimeListener();
                    } else {
                        // Usar un ID an√≥nimo si no hay autenticaci√≥n, aunque Canvas garantiza un token.
                        window.currentUserId = crypto.randomUUID();
                        console.log("Iniciando sesi√≥n an√≥nima (ID aleatorio):", window.currentUserId);
                        // A√∫n as√≠, esperamos el listener para configurar la referencia
                    }
                });

            } catch (e) {
                console.error("Error en la inicializaci√≥n de Firebase:", e);
            }
        };

        // Exportar initFirebase para usarlo en el script principal
        window.initFirebase = initFirebase;
    </script>
    <style>
        /* --- CONFIGURACI√ìN DE VARIABLES Y TEMA --- */
        :root {
            --neon-cyan: #22d3ee;
            --neon-lime: #a3e635;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #e5e7eb;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Utilidades */
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .neon-title { text-shadow: 0 0 5px rgba(34, 211, 238, 0.8); }
        
        /* --- ESTILOS DE TABLA (Simulaci√≥n Excel) --- */
        #inventory-table {
            border-collapse: separate; 
            border-spacing: 0;
            width: 100%;
            border: 1px solid #374151;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
        }
        
        .table-header, .table-data {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
        }

        .table-header {
            background-color: #1f2937;
            color: #22d3ee;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .table-row { transition: background-color 0.2s; }
        .table-row:last-child .table-data { border-bottom: none; }
        
        /* Modo Oscuro (Default) */
        .table-row:hover { background-color: #1f2937; }
        
        .product-cell {
            font-size: 0.95rem;
            color: #e5e7eb;
            border-right: 1px solid #374151;
        }

        .qty-cell {
            text-align: center;
            font-weight: bold;
            color: #a3e635;
            background-color: rgba(17, 24, 39, 0.5);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .qty-cell:hover {
            background-color: #374151;
            text-decoration: underline;
        }
        .zero-qty { color: #9ca3af !important; }

        /* --- TEMA CLARO --- */
        .light-theme body { background-color: #f3f4f6; color: #1f2937; }
        .light-theme .main-container { background-color: #ffffff; border-color: #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .light-theme .neon-title { color: #2563eb; text-shadow: none; }
        .light-theme .accent-text { color: #2563eb; }
        
        /* Tabla Claro */
        .light-theme #inventory-table { border-color: #e5e7eb; }
        .light-theme .table-header { background-color: #bfdbfe; color: #1e40af; border-bottom: 1px solid #93c5fd; }
        .light-theme .table-data { border-bottom: 1px solid #e5e7eb; }
        .light-theme .product-cell { color: #1f2937; border-right: 1px solid #e5e7eb; }
        .light-theme .table-row:hover { background-color: #f0f9ff; }
        .light-theme .qty-cell { background-color: #ecfdf5; color: #059669; }
        .light-theme .qty-cell:hover { background-color: #d1fae5; }
        .light-theme .zero-qty { color: #6b7280 !important; }

        /* Inputs y Footer Claro */
        .light-theme input[type="text"] { background-color: #ffffff; border-color: #94a3b8; color: #0f172a; }
        .light-theme .footer-container { background-color: #e2e8f0; border-color: #94a3b8; }
    </style>
</head>
<body class="p-2 md:p-6 min-h-screen">

    <div class="max-w-4xl mx-auto bg-gray-900 p-4 md:p-8 rounded-2xl shadow-2xl border border-cyan-900 main-container">
        <header class="mb-4">
            <!-- Cabecera tipo Reporte -->
            <div class="border border-gray-700 p-4 rounded-xl mb-6 bg-gray-800/50 light-theme:bg-white light-theme:border-blue-200 transition-colors">
                <!-- Fila 1: ORGANISMO Y FECHA -->
                <div class="flex flex-col md:flex-row justify-between md:items-center border-b border-gray-700 pb-2 mb-2 light-theme:border-gray-200">
                    <p class="text-xs font-bold text-cyan-400 light-theme:text-blue-600 tracking-wide mb-1 md:mb-0">ORGANISMO DE INTEGRACI√ìN COOPERATIVA CECOSESOLA, R.L. J085030140</p>
                    <p class="text-xs text-gray-400 light-theme:text-gray-500">FECHA: <span id="report-date" class="font-semibold text-gray-200 light-theme:text-gray-800"></span></p>
                </div>
                
                <!-- Fila 2: PASILLO Y RESPONSABLES -->
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div class="mb-2 md:mb-0">
                        <h2 class="text-2xl md:text-3xl font-extrabold text-cyan-400 neon-title light-theme:text-blue-700 uppercase">‚òïPASILLO CAFE‚òïü•´</h2>
                        <h3 class="text-lg font-bold text-gray-300 light-theme:text-gray-600">FERIA DEL ESTE</h3>
                    </div>
                    
                    <div class="text-sm w-full md:w-auto bg-gray-900/50 p-2 rounded light-theme:bg-gray-100">
                        <p class="text-gray-400 light-theme:text-gray-500 mb-1">RESPONSABLE 1: <span id="resp1-display" class="font-semibold text-white light-theme:text-gray-800 uppercase">SIN NOMBRE</span></p>
                        <p class="text-gray-400 light-theme:text-gray-500">RESPONSABLE 2: <span id="resp2-display" class="font-semibold text-white light-theme:text-gray-800 uppercase">SIN NOMBRE</span></p>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex justify-end space-x-3 items-center sticky top-2 z-10 bg-gray-900/90 p-2 rounded-xl backdrop-blur-sm light-theme:bg-white/90">
                <div class="flex space-x-3 ml-auto">
                    <button 
                        id="toggle-theme-btn"
                        onclick="toggleTheme()"
                        class="p-2 rounded-full text-cyan-400 hover:bg-gray-700 transition duration-200 border border-transparent hover:border-gray-600 light-theme:hover:bg-blue-100 light-theme:text-blue-600"
                        aria-label="Cambiar tema"
                    >
                        <!-- Luna -->
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 12.001 12.001 0 0012 21a12.001 12.001 0 008.354-5.646z" />
                        </svg>
                        <!-- Sol -->
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>

                    <!-- Bot√≥n Reset (Borrar Todo) -->
                    <button 
                        onclick="openResetModal()"
                        class="bg-red-600/80 hover:bg-red-500 text-white p-2 rounded-xl shadow-lg transition duration-200 transform hover:scale-105 active:scale-95"
                        title="Borrar todos los datos y empezar de nuevo"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    
                    <button 
                        onclick="downloadExcel()"
                        class="bg-lime-500 hover:bg-lime-400 text-gray-900 font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200 flex items-center transform hover:scale-105 active:scale-95 text-sm md:text-base"
                        title="Descargar datos en formato CSV para Excel"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Descargar CSV
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabla de Inventario -->
        <div class="mt-4 overflow-x-auto">
            <table id="inventory-table">
                <thead>
                    <tr>
                        <th class="table-header text-left w-[75%] md:w-[80%] pl-4 sticky left-0 z-10">PRODUCTO</th>
                        <th class="table-header w-[25%] md:w-[20%]">CANTIDAD</th>
                    </tr>
                </thead>
                <tbody id="inventory-list">
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>

        <!-- Footer / Resumen -->
        <footer class="mt-8 pt-6 border-t-4 border-cyan-600 bg-gray-800 rounded-lg p-4 shadow-xl footer-container transition-colors">
            <div class="flex flex-col sm:flex-row items-start sm:items-stretch justify-between gap-6">
                
                <!-- Contador -->
                <div class="w-full sm:w-1/2 flex flex-col"> 
                    <p class="text-lg font-bold text-cyan-400 mb-2 accent-text uppercase">Items con Existencia ( > 0 ):</p>
                    <div class="flex-grow bg-cyan-600/20 border border-cyan-600/50 rounded-xl p-4 flex items-center justify-center">
                        <span id="stocked-products-count" class="text-5xl font-extrabold text-cyan-400 light-theme:text-blue-600">0</span>
                    </div>
                </div>
                
                <!-- Inputs Responsables -->
                <div class="w-full sm:w-1/2 flex flex-col space-y-3 sm:pl-4 sm:border-l border-gray-600 light-theme:border-gray-300">
                    <div>
                        <label class="text-sm font-semibold text-gray-400 light-theme:text-gray-600 uppercase block mb-1">Responsable 1</label>
                        <input type="text" id="responsable-1" placeholder="Nombre y Apellido" class="w-full p-2 rounded border border-gray-600 bg-gray-900 text-white focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" oninput="updateReportHeaders()">
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-400 light-theme:text-gray-600 uppercase block mb-1">Responsable 2</label>
                        <input type="text" id="responsable-2" placeholder="Nombre y Apellido" class="w-full p-2 rounded border border-gray-600 bg-gray-900 text-white focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" oninput="updateReportHeaders()">
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Calculadora -->
    <div id="calculator-modal" class="modal-overlay" onclick="if(event.target === this) closeCalculator()">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-xs mx-4 transform transition-all border border-cyan-700 relative">
            <!-- Header Calc -->
            <div class="mb-4 text-center">
                <h2 class="text-lg font-bold text-cyan-400 leading-tight truncate px-2" id="calc-product-name">Producto</h2>
            </div>

            <!-- Pantalla -->
            <div class="bg-gray-900 p-3 mb-4 rounded-lg text-right border border-gray-700 shadow-inner">
                <div class="text-gray-500 text-xs h-4 mb-1 truncate" id="calc-history"></div>
                <div id="calc-display" class="text-white text-4xl font-mono font-bold truncate tracking-widest">0</div>
            </div>

            <!-- Teclado -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="clearCalculator()" class="col-span-1 bg-red-900/80 text-red-200 rounded-lg p-3 font-bold hover:bg-red-800">C</button>
                <button onclick="backspaceCalculator()" class="col-span-1 bg-red-900/80 text-red-200 rounded-lg p-3 font-bold hover:bg-red-800">‚å´</button>
                <button onclick="handleOperator('/')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">√∑</button>
                <button onclick="handleOperator('*')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">√ó</button>

                <button onclick="inputDigit('7')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">7</button>
                <button onclick="inputDigit('8')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">8</button>
                <button onclick="inputDigit('9')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">9</button>
                <button onclick="handleOperator('-')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">-</button>

                <button onclick="inputDigit('4')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">4</button>
                <button onclick="inputDigit('5')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">5</button>
                <button onclick="inputDigit('6')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">6</button>
                <button onclick="handleOperator('+')" class="bg-gray-700 text-cyan-400 rounded-lg p-3 font-bold hover:bg-gray-600">+</button>

                <button onclick="inputDigit('1')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">1</button>
                <button onclick="inputDigit('2')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">2</button>
                <button onclick="inputDigit('3')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">3</button>
                <button onclick="handleOperator('=')" class="row-span-2 bg-cyan-600 text-white rounded-lg p-3 font-bold hover:bg-cyan-500 shadow-lg flex items-center justify-center text-xl">=</button>

                <button onclick="inputDigit('0')" class="col-span-2 bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">0</button>
                <button onclick="inputDigit('.')" class="bg-gray-600 text-white rounded-lg p-3 font-bold hover:bg-gray-500">.</button>
            </div>

            <!-- Botones Control -->
            <div class="flex space-x-2">
                <button onclick="closeCalculator()" class="flex-1 py-3 bg-gray-700 text-gray-300 rounded-xl font-semibold hover:bg-gray-600">Cancelar</button>
                <button onclick="saveAndClose()" class="flex-1 py-3 bg-lime-600 text-white rounded-xl font-bold hover:bg-lime-500 shadow-lg shadow-lime-900/20">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Borrar -->
    <div id="reset-modal" class="modal-overlay" onclick="if(event.target === this) closeResetModal()">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 transform transition-all border border-red-700">
            <h3 class="text-xl font-bold text-red-400 mb-4">‚ö†Ô∏è Confirmar Borrado Total</h3>
            <p class="text-gray-300 mb-6">Est√°s a punto de **eliminar todo el inventario** de la base de datos de forma permanente. Esta acci√≥n no se puede deshacer.</p>
            <p class="text-white font-semibold mb-6">¬øEst√°s absolutamente seguro de que deseas continuar?</p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeResetModal()" class="py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Cancelar</button>
                <button onclick="resetAllDataConfirmed()" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition shadow-lg">S√≠, Borrar Todo</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar funciones de Firestore
        import { doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATOS INICIALES Y ESTRUCTURA ---
        const productNames = [
            "ACEITE DE SOYA 1 LITRO", "ACEITE DE SOYA LA LUCHA 828ML", "ACEITE MAZEITE 1 LITRO", "ACEITE NATUROL 850ML", 
            "ACEITE SANTA LUC√çA 828ML", "ACEITE SANTA LUC√çA 900ML", "ACEITE VATEL 1 LITRO", "ACEITE VATEL 500ML", 
            "AFRECHO", "ALI√ëOS C√öRCUMA", "ALI√ëOS SAN MIGUEL GRANDE", "ALI√ëOS SAN MIGUEL PEQUE√ëO", 
            "AT√öN AMANTINA 170 GRS", "AT√öN PE√ëERO VERDE 170 GRS", "AT√öN SOLIDO DIFIORE 170G", "AVENA DON JORGE 400 GRS", 
            "AVENA QUAKER", "AVENA VICON√â 400GR", "CAF√â ALUMINIO BARINAS", "CAF√â CORDILLERA 200 GRS", 
            "CAF√â CORDILLERA 500 GRS", "CAF√â EN GRANO DULCE AMARGO 250 GRS", "CAF√â EN GRANO DULCE AMARGO 400GR", 
            "CAF√â LO NUESTRO", "CAF√â MATILDE 200 GR", "CARNE DE SOYA SOY TEX 200GRS", "FORORO VALLE HONDO", 
            "HARINA DE AVENA QUAKER 400GRS", "HARINA DE TRIGO DULCE MAR LEUDANTE 1 KG", "HARINA DE TRIGO DULCE MAR TODO USO 1 KG", 
            "HARINA DE TRIGO MARY 1 KG", "LECHE DO BOON 400GR", "LECHE PURELAC 200GR", "LECHE PURELAC 400GR", 
            "LECHE VALLE HONDO 400 GRS", "PASTA DE 8 DE MARZO CORTA 500GR", "PASTA DE 8 DE MARZO LARGA 500GR", 
            "SARDINA INCOSA EN ACEITE 170 GR", "SARDINA INCOSA DE TOMATE 170 GR", "SARDINA MARGARITA DE TOMATE 170 GR", 
            "SARDINA MARGARITA EN ACEITE 170 GR", "SARDINA MARGARITA PICANTE 170 GR", "TAMARINDO EL ESFUERZO 400 GR", 
            "TAMARINDO ETNA 400 GR", "VAINILLA"
        ];

        let inventoryData = [];
        let responsables = { resp1: "SIN NOMBRE", resp2: "SIN NOMBRE" };

        // Funci√≥n para generar la estructura de inventario inicial
        const getInitialInventoryData = () => productNames.map(name => ({
            name: name,
            quantity: 0,
            history: "0" // El historial inicial es solo la cantidad
        }));
        
        // --- FIREBASE: LECTURA EN TIEMPO REAL (onSnapshot) ---
        window.startRealtimeListener = () => {
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible.");
                return;
            }

            onSnapshot(window.inventoryRef, (docSnapshot) => {
                let data = docSnapshot.data();

                if (docSnapshot.exists() && data && Array.isArray(data.inventory)) {
                    // Datos encontrados: Usar datos de Firestore
                    inventoryData = data.inventory;
                    responsables.resp1 = data.responsable1 || "SIN NOMBRE";
                    responsables.resp2 = data.responsable2 || "SIN NOMBRE";
                    console.log("Datos de Firestore cargados.");
                } else {
                    // Datos no encontrados o estructura inv√°lida: Inicializar y guardar en DB
                    console.log("Datos no encontrados, inicializando y guardando estructura base.");
                    inventoryData = getInitialInventoryData();
                    // Guardar la estructura inicial en la DB
                    saveInventoryData(); 
                }
                
                // 4. Actualizar toda la UI con los datos cargados/inicializados
                renderInventoryTable();
                updateReportHeaders(false); // No guardar de nuevo, ya se carg√≥ de la DB
                calculateTotalItems();
            }, (error) => {
                console.error("Error al escuchar la base de datos:", error);
                // Mostrar un error en la consola, pero no en la UI, como se solicit√≥
            });
        };

        // --- FIREBASE: ESCRITURA (setDoc) ---
        async function saveInventoryData() {
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible para guardar.");
                return;
            }
            try {
                const dataToSave = {
                    inventory: inventoryData,
                    responsable1: document.getElementById('responsable-1').value || "SIN NOMBRE",
                    responsable2: document.getElementById('responsable-2').value || "SIN NOMBRE",
                    lastUpdated: new Date().toISOString()
                };
                await setDoc(window.inventoryRef, dataToSave);
                console.log("Datos guardados en Firestore.");
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
            }
        }

        // --- FIREBASE: BORRADO (deleteDoc) ---
        async function resetAllDataConfirmed() {
            closeResetModal();
            if (!window.inventoryRef) {
                console.error("Referencia de inventario no disponible para borrar.");
                return;
            }
            try {
                await deleteDoc(window.inventoryRef);
                console.log("Documento de inventario borrado.");
                // onSnapshot se encargar√° de re-inicializar la estructura
            } catch (e) {
                console.error("Error al borrar el inventario:", e);
            }
        }

        // --- MANEJO DE UI Y DATOS LOCALES ---

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            window.initFirebase(); // Iniciar Firebase y la autenticaci√≥n
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        });

        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-list');
            tbody.innerHTML = ''; 

            inventoryData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                const zeroClass = item.quantity === 0 ? 'zero-qty' : '';

                tr.innerHTML = `
                    <td class="table-data product-cell">${item.name}</td>
                    <td class="table-data qty-cell ${zeroClass}" 
                        onclick="openCalculator(${index}, '${item.name.replace(/'/g, "\\'")}')"
                        id="qty-cell-${index}">
                        <span id="qty-display-${index}" data-quantity="${item.quantity}" data-history="${item.history || '0'}">${item.quantity}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateReportHeaders(shouldSave = true) {
            const r1Input = document.getElementById('responsable-1');
            const r2Input = document.getElementById('responsable-2');
            
            // Si cargamos de la DB, actualizar inputs primero
            if (!shouldSave) {
                r1Input.value = responsables.resp1 === "SIN NOMBRE" ? "" : responsables.resp1;
                r2Input.value = responsables.resp2 === "SIN NOMBRE" ? "" : responsables.resp2;
            }

            const r1 = r1Input.value || "SIN NOMBRE";
            const r2 = r2Input.value || "SIN NOMBRE";

            document.getElementById('resp1-display').textContent = r1.toUpperCase();
            document.getElementById('resp2-display').textContent = r2.toUpperCase();
            
            if (shouldSave) {
                saveInventoryData(); // Guardar cambios de responsables en DB
            }
        }

        function calculateTotalItems() {
            const count = inventoryData.filter(i => (parseInt(i.quantity) || 0) > 0).length;
            document.getElementById('stocked-products-count').textContent = count;
        }

        // --- L√ìGICA DE CALCULADORA ---
        const calculator = {
            displayValue: '0',
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
            currentProductIndex: null,
            fullExpression: '0',
            isResultCalculated: false, // Indica si el display muestra un resultado final o el valor cargado de la DB
        };

        function openCalculator(index, productName) {
            calculator.currentProductIndex = index;
            document.getElementById('calc-product-name').innerText = productName;
            
            const currentQty = inventoryData[index].quantity;
            // El historial debe ser la expresi√≥n completa guardada, o la cantidad si no hay historial
            const currentHist = inventoryData[index].history || String(currentQty); 
            
            clearCalculator(false); 
            
            calculator.displayValue = String(currentQty);
            calculator.fullExpression = currentHist;
            // Configuramos el primer operando como la cantidad actual y la bandera de resultado
            calculator.firstOperand = parseFloat(currentQty);
            calculator.isResultCalculated = true; 

            updateDisplay();
            document.getElementById('calculator-modal').style.display = 'flex';
        }

        function closeCalculator() {
            document.getElementById('calculator-modal').style.display = 'none';
            calculator.currentProductIndex = null;
        }

        function updateDisplay() {
            const display = document.getElementById('calc-display');
            const history = document.getElementById('calc-history');
            
            display.textContent = calculator.displayValue;
            history.textContent = calculator.fullExpression;

            // Ajuste de tama√±o de fuente para grandes n√∫meros
            if(calculator.displayValue.length > 9) {
                display.style.fontSize = '1.5rem';
            } else {
                display.style.fontSize = '2.25rem';
            }
        }

        // *** L√ìGICA CORREGIDA PARA inputDigit ***
        function inputDigit(digit) {
            const { displayValue, waitingForSecondOperand, isResultCalculated } = calculator;

            // 1. Empezar un c√°lculo nuevo (despu√©s de '=' o carga inicial)
            if (isResultCalculated) {
                if (digit === '.') {
                    calculator.displayValue = '0.';
                    calculator.fullExpression = '0.';
                } else {
                    calculator.displayValue = digit;
                    calculator.fullExpression = digit;
                }
                calculator.isResultCalculated = false;
                calculator.firstOperand = null; // Borrar el primer operando si empezamos de cero
                calculator.waitingForSecondOperand = false; 

            } else if (digit === '.') {
                // 2. Manejar punto decimal para un c√°lculo en curso
                if (displayValue.includes('.')) return;
                
                // Si esperamos un segundo operando (operador reci√©n presionado), empezamos el nuevo n√∫mero con 0.
                if (waitingForSecondOperand) {
                     calculator.displayValue = '0.';
                     calculator.fullExpression += '0.';
                     calculator.waitingForSecondOperand = false;
                } else {
                    // Agregar el punto decimal
                    calculator.displayValue = displayValue + digit;
                    calculator.fullExpression += digit;
                }
            } else if (waitingForSecondOperand) {
                // 3. Inicio del segundo operando despu√©s de un operador
                calculator.displayValue = digit;
                calculator.waitingForSecondOperand = false;
                calculator.fullExpression += digit;
            } else {
                // 4. Continuaci√≥n del operando actual
                if (displayValue === '0' && digit !== '0') {
                    // Reemplazar el '0' inicial en el display y la expresi√≥n
                    calculator.displayValue = digit;
                    calculator.fullExpression = calculator.fullExpression.slice(0, -1) + digit; // Reemplaza el √∫ltimo '0'
                } else {
                    calculator.displayValue = displayValue === '0' ? digit : displayValue + digit;
                    if(calculator.fullExpression === '0' && digit !== '.') {
                         calculator.fullExpression = digit;
                    } else {
                         calculator.fullExpression += digit;
                    }
                }
            }
            updateDisplay();
        }

        // *** L√ìGICA CORREGIDA PARA handleOperator ***
        function handleOperator(nextOperator) {
            const { firstOperand, displayValue, operator, waitingForSecondOperand } = calculator;
            const inputValue = parseFloat(displayValue);

            // 1. Manejar reemplazo de operador (ej: 5+ luego presiona -)
            if (operator && waitingForSecondOperand && nextOperator !== '=') {
                calculator.operator = nextOperator;
                // Reemplazar el operador al final de la expresi√≥n
                calculator.fullExpression = calculator.fullExpression.replace(/[-+*/]$/, nextOperator);
                updateDisplay();
                return;
            }
            
            if (isNaN(inputValue)) return;

            // 2. Realizar C√°lculo si existe un operador y no estamos esperando el segundo operando (c√°lculo en cadena)
            if (firstOperand !== null && operator && !waitingForSecondOperand) {
                const result = performCalculation(firstOperand, inputValue, operator);
                calculator.displayValue = String(result);
                calculator.firstOperand = result;
                // NOTA: fullExpression NO se modifica aqu√≠, se mantiene la cadena de operaciones para el CSV.
            } else if (firstOperand === null || calculator.isResultCalculated) {
                 // Iniciar de cero o despu√©s de '='
                 calculator.firstOperand = inputValue;
            }

            // 3. Establecer el siguiente operador/estado
            if (nextOperator === '=') {
                calculator.operator = null;
                calculator.waitingForSecondOperand = true;
                calculator.isResultCalculated = true; 
                // La fullExpression se mantiene como la expresi√≥n que acaba de ser evaluada (ej: 5+3)
                
            } else {
                calculator.waitingForSecondOperand = true;
                calculator.operator = nextOperator;
                calculator.isResultCalculated = false;
                
                // Si la pantalla muestra un resultado final (isResultCalculated era true),
                // la nueva expresi√≥n comienza con ese resultado.
                if (calculator.isResultCalculated) {
                     calculator.fullExpression = calculator.displayValue;
                }
                
                // Agregar el operador a la full expression
                calculator.fullExpression += nextOperator;
            }
            updateDisplay();
        }

        function performCalculation(first, second, op) {
            let result;
            if (op === '+') result = first + second;
            if (op === '-') result = first - second;
            if (op === '*') result = first * second;
            if (op === '/') result = second !== 0 ? first / second : 0; 
            
            // Redondear a 4 decimales para evitar problemas de flotantes
            return Math.round(result * 10000) / 10000;
        }

        function clearCalculator(resetUI = true) {
            calculator.displayValue = '0';
            calculator.firstOperand = null;
            calculator.waitingForSecondOperand = false;
            calculator.operator = null;
            calculator.fullExpression = '0';
            calculator.isResultCalculated = false;
            if(resetUI) updateDisplay();
        }

        function backspaceCalculator() {
            if(calculator.isResultCalculated) { clearCalculator(); return; }
            
            let val = calculator.displayValue;
            let expr = calculator.fullExpression;
            
            // Borra el √∫ltimo d√≠gito del valor mostrado (displayValue)
            calculator.displayValue = val.length > 1 ? val.slice(0, -1) : '0';
            
            // Borra el √∫ltimo car√°cter de la expresi√≥n completa (fullExpression)
            // Solo si la expresi√≥n no es ya un simple '0'
            if (expr.length > 1) {
                calculator.fullExpression = expr.slice(0, -1);
            } else {
                calculator.fullExpression = '0';
            }
            
            // Si el display vuelve a '0' despu√©s de borrar, podr√≠a implicar un cambio de estado,
            // pero para simplificar, confiamos en la l√≥gica anterior.

            updateDisplay();
        }

        // *** L√ìGICA CORREGIDA PARA saveAndClose ***
        function saveAndClose() {
            if(calculator.currentProductIndex === null) return;

            // Finalizar cualquier operaci√≥n pendiente antes de guardar
            if(calculator.operator && !calculator.waitingForSecondOperand) {
                // Forzar la operaci√≥n para obtener el resultado final
                const result = performCalculation(calculator.firstOperand, parseFloat(calculator.displayValue), calculator.operator);
                calculator.displayValue = String(result);
            }
            
            let finalVal = parseFloat(calculator.displayValue);
            if(isNaN(finalVal) || finalVal < 0) finalVal = 0;
            finalVal = Math.floor(finalVal); // Las cantidades de inventario son enteras

            // Actualizar datos locales y luego guardar en DB
            inventoryData[calculator.currentProductIndex].quantity = finalVal;
            // Guardar la expresi√≥n completa registrada en la calculadora
            inventoryData[calculator.currentProductIndex].history = calculator.fullExpression; 
            
            saveInventoryData(); // GUARDAR en Firestore (as√≠ncrono)
            
            // onSnapshot se encargar√° de actualizar la tabla, pero podemos cerrar el modal inmediatamente
            closeCalculator();
        }
        
        // --- MODAL DE CONFIRMACI√ìN ---
        function openResetModal() {
            document.getElementById('reset-modal').style.display = 'flex';
        }

        function closeResetModal() {
            document.getElementById('reset-modal').style.display = 'none';
        }


        // --- EXPORTAR EXCEL (CSV) ---
        function downloadExcel() {
            const resp1 = document.getElementById('responsable-1').value || "SIN NOMBRE";
            const resp2 = document.getElementById('responsable-2').value || "SIN NOMBRE";
            const fecha = document.getElementById('report-date').textContent;
            
            let csvContent = "\uFEFF"; // BOM para asegurar que Excel reconozca UTF-8
            
            // Cabecera Reporte
            // Usamos ";;" para forzar que el t√≠tulo ocupe 3 columnas, simulando el centrado en Excel.
            csvContent += `REPORTE DE INVENTARIO - PASILLO CAFE;;\n`;
            csvContent += `CECOSESOLA R.L.;;\n`; // L√≠nea de la organizaci√≥n
            csvContent += `FECHA:;${fecha}\n`;
            csvContent += `RESPONSABLE 1:;${resp1.toUpperCase()}\n`;
            csvContent += `RESPONSABLE 2:;${resp2.toUpperCase()}\n\n`;

            // Columnas: ORDEN CAMBIADO A PRODUCTO, HISTORIAL, CANTIDAD
            csvContent += "PRODUCTO;HISTORIAL (OPERACIONES);CANTIDAD\n";

            inventoryData.forEach(row => {
                // Datos en el nuevo orden, usando punto y coma como separador
                // row.history ahora contiene la expresi√≥n completa, tal como se corrigi√≥.
                csvContent += `${row.name};${row.history};${row.quantity}\n`;
            });
            
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            const cleanDate = fecha.replace(/\//g, '-');
            
            link.setAttribute("href", url);
            link.setAttribute("download", `Inventario_CAFE_${cleanDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- UTILIDADES UI ---
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            document.getElementById('moon-icon').classList.toggle('hidden', isLight);
            document.getElementById('sun-icon').classList.toggle('hidden', !isLight);
            
            // Volver a renderizar para aplicar correctamente los colores de cantidad
            renderInventoryTable();
        }

        // Exponer funciones globales para onclick
        window.openCalculator = openCalculator;
        window.closeCalculator = closeCalculator;
        window.clearCalculator = clearCalculator;
        window.backspaceCalculator = backspaceCalculator;
        window.handleOperator = handleOperator;
        window.inputDigit = inputDigit;
        window.saveAndClose = saveAndClose;
        window.updateReportHeaders = updateReportHeaders;
        window.downloadExcel = downloadExcel;
        window.toggleTheme = toggleTheme;
        window.openResetModal = openResetModal;
        window.closeResetModal = closeResetModal;
        window.resetAllDataConfirmed = resetAllDataConfirmed;
    </script>
</body>
</html>
